import * as tslib_1 from "tslib";
import { AsyncIterableX } from '../asynciterable';
import { bindCallback } from '../internal/bindcallback';
import { identityAsync } from '../internal/identity';
import { toLength } from '../internal/tolength';
import { isIterable, isAsyncIterable } from '../internal/isiterable';
class FromArrayIterable extends AsyncIterableX {
    constructor(source, selector) {
        super();
        this._source = source;
        this._selector = selector;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            let i = 0;
            const length = toLength(this._source.length);
            while (i < length) {
                yield yield tslib_1.__await(this._selector(this._source[i], i++));
            }
        });
    }
}
class FromAsyncIterable extends AsyncIterableX {
    constructor(source, selector) {
        super();
        this._source = source;
        this._selector = selector;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            let i = 0;
            try {
                for (var _a = tslib_1.__asyncValues(this._source), _b; _b = yield tslib_1.__await(_a.next()), !_b.done;) {
                    let item = yield tslib_1.__await(_b.value);
                    yield yield tslib_1.__await(this._selector(item, i++));
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (_b && !_b.done && (_c = _a.return)) yield tslib_1.__await(_c.call(_a));
                }
                finally { if (e_1) throw e_1.error; }
            }
            var e_1, _c;
        });
    }
}
class FromPromiseIterable extends AsyncIterableX {
    constructor(source, selector) {
        super();
        this._source = source;
        this._selector = selector;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            const item = yield tslib_1.__await(this._source);
            yield yield tslib_1.__await(this._selector(item, 0));
        });
    }
}
class AsyncObserver {
    constructor() {
        this.values = [];
        this.hasCompleted = false;
        this.hasError = false;
        this.errorValue = null;
        this.closed = false;
    }
    next(value) {
        if (!this.closed) {
            this.values.push(value);
        }
    }
    error(err) {
        if (!this.closed) {
            this.closed = true;
            this.hasError = true;
            this.errorValue = err;
        }
    }
    complete() {
        if (!this.closed) {
            this.closed = true;
        }
    }
}
class FromObservableAsyncIterable extends AsyncIterableX {
    constructor(observable, selector) {
        super();
        this._observable = observable;
        this._selector = selector;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            const observer = new AsyncObserver();
            const subscription = this._observable.subscribe(observer);
            let i = 0;
            while (1) {
                if (observer.values.length > 0) {
                    yield yield tslib_1.__await(this._selector(observer.values.shift(), i++));
                }
                else if (observer.closed) {
                    subscription.unsubscribe();
                    if (observer.hasError) {
                        throw observer.errorValue;
                    }
                    else {
                        break;
                    }
                }
            }
        });
    }
}
function isPromise(x) {
    return x != null && Object(x) === x && typeof x['then'] === 'function';
}
function isObservable(x) {
    return x != null && Object(x) === x && typeof x['subscribe'] === 'function';
}
function isArrayLike(x) {
    return x != null && Object(x) === x && typeof x['length'] === 'number';
}
export function from(source, selector = identityAsync, thisArg) {
    const fn = bindCallback(selector, thisArg, 2);
    if (isIterable(source) || isAsyncIterable(source)) {
        return new FromAsyncIterable(source, fn);
    }
    if (isPromise(source)) {
        return new FromPromiseIterable(source, fn);
    }
    if (isObservable(source)) {
        return new FromObservableAsyncIterable(source, fn);
    }
    if (isArrayLike(source)) {
        return new FromArrayIterable(source, fn);
    }
    throw new TypeError('Input type not supported');
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsSUFBSSxpQkFBaUIsQ0FBbUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLG1CQUFtQixDQUFtQixNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsTUFBTSxDQUFDLElBQUksMkJBQTJCLENBQW1CLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixNQUFNLENBQUMsSUFBSSxpQkFBaUIsQ0FBbUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCxNQUFNLElBQUksU0FBUyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDbEQsQ0FBQyIsImZpbGUiOiJhc3luY2l0ZXJhYmxlL2Zyb20uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3luY0l0ZXJhYmxlWCB9IGZyb20gJy4uL2FzeW5jaXRlcmFibGUnO1xuaW1wb3J0IHsgYmluZENhbGxiYWNrIH0gZnJvbSAnLi4vaW50ZXJuYWwvYmluZGNhbGxiYWNrJztcbmltcG9ydCB7IGlkZW50aXR5QXN5bmMgfSBmcm9tICcuLi9pbnRlcm5hbC9pZGVudGl0eSc7XG5pbXBvcnQgeyB0b0xlbmd0aCB9IGZyb20gJy4uL2ludGVybmFsL3RvbGVuZ3RoJztcbmltcG9ydCB7IGlzSXRlcmFibGUsIGlzQXN5bmNJdGVyYWJsZSB9IGZyb20gJy4uL2ludGVybmFsL2lzaXRlcmFibGUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJy4uL29ic2VydmVyJztcblxuY2xhc3MgRnJvbUFycmF5SXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdCA9IFRTb3VyY2U+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZVg8VFJlc3VsdD4ge1xuICBwcml2YXRlIF9zb3VyY2U6IEFycmF5TGlrZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IEFycmF5TGlrZTxUU291cmNlPixcbiAgICAgIHNlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zb3VyY2UgPSBzb3VyY2U7XG4gICAgdGhpcy5fc2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgfVxuXG4gIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkge1xuICAgIGxldCBpID0gMDtcbiAgICBjb25zdCBsZW5ndGggPSB0b0xlbmd0aCgoPEFycmF5TGlrZTxUU291cmNlPj50aGlzLl9zb3VyY2UpLmxlbmd0aCk7XG4gICAgd2hpbGUgKGkgPCBsZW5ndGgpIHtcbiAgICAgIHlpZWxkIGF3YWl0IHRoaXMuX3NlbGVjdG9yKHRoaXMuX3NvdXJjZVtpXSwgaSsrKTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgRnJvbUFzeW5jSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdCA9IFRTb3VyY2U+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZVg8VFJlc3VsdD4ge1xuICBwcml2YXRlIF9zb3VyY2U6IEl0ZXJhYmxlPFRTb3VyY2UgfCBQcm9taXNlTGlrZTxUU291cmNlPj4gfCBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+O1xuICBwcml2YXRlIF9zZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0PjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHNvdXJjZTogSXRlcmFibGU8VFNvdXJjZSB8IFByb21pc2VMaWtlPFRTb3VyY2U+PiB8IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgICBzZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0Pikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc291cmNlID0gc291cmNlO1xuICAgIHRoaXMuX3NlbGVjdG9yID0gc2VsZWN0b3I7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBsZXQgaSA9IDA7XG4gICAgZm9yIGF3YWl0IChsZXQgaXRlbSBvZiA8QXN5bmNJdGVyYWJsZTxUU291cmNlPj50aGlzLl9zb3VyY2UpIHtcbiAgICAgIHlpZWxkIGF3YWl0IHRoaXMuX3NlbGVjdG9yKGl0ZW0sIGkrKyk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZyb21Qcm9taXNlSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdCA9IFRTb3VyY2U+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZVg8VFJlc3VsdD4ge1xuICBwcml2YXRlIF9zb3VyY2U6IFByb21pc2VMaWtlPFRTb3VyY2U+O1xuICBwcml2YXRlIF9zZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0PjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICAgIHNvdXJjZTogUHJvbWlzZUxpa2U8VFNvdXJjZT4sXG4gICAgICBzZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0Pikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc291cmNlID0gc291cmNlO1xuICAgIHRoaXMuX3NlbGVjdG9yID0gc2VsZWN0b3I7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBjb25zdCBpdGVtID0gYXdhaXQgdGhpcy5fc291cmNlO1xuICAgIHlpZWxkIGF3YWl0IHRoaXMuX3NlbGVjdG9yKGl0ZW0sIDApO1xuICB9XG59XG5cbmNsYXNzIEFzeW5jT2JzZXJ2ZXI8VFNvdXJjZT4ge1xuICBwdWJsaWMgdmFsdWVzOiBUU291cmNlW107XG4gIHB1YmxpYyBoYXNFcnJvcjogYm9vbGVhbjtcbiAgcHVibGljIGhhc0NvbXBsZXRlZDogYm9vbGVhbjtcbiAgcHVibGljIGVycm9yVmFsdWU6IGFueTtcbiAgcHVibGljIGNsb3NlZDogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnZhbHVlcyA9IFtdO1xuICAgIHRoaXMuaGFzQ29tcGxldGVkID0gZmFsc2U7XG4gICAgdGhpcy5oYXNFcnJvciA9IGZhbHNlO1xuICAgIHRoaXMuZXJyb3JWYWx1ZSA9IG51bGw7XG4gICAgdGhpcy5jbG9zZWQgPSBmYWxzZTtcbiAgfVxuXG4gIG5leHQodmFsdWU6IFRTb3VyY2UpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VkKSB7XG4gICAgICB0aGlzLnZhbHVlcy5wdXNoKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBlcnJvcihlcnI6IGFueSkge1xuICAgIGlmICghdGhpcy5jbG9zZWQpIHtcbiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTtcbiAgICAgIHRoaXMuaGFzRXJyb3IgPSB0cnVlO1xuICAgICAgdGhpcy5lcnJvclZhbHVlID0gZXJyO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBsZXRlKCkge1xuICAgIGlmICghdGhpcy5jbG9zZWQpIHtcbiAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cblxuY2xhc3MgRnJvbU9ic2VydmFibGVBc3luY0l0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfb2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBvYnNlcnZhYmxlOiBPYnNlcnZhYmxlPFRTb3VyY2U+LFxuICAgICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX29ic2VydmFibGUgPSBvYnNlcnZhYmxlO1xuICAgIHRoaXMuX3NlbGVjdG9yID0gc2VsZWN0b3I7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBjb25zdCBvYnNlcnZlciA9IG5ldyBBc3luY09ic2VydmVyPFRTb3VyY2U+KCk7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5fb2JzZXJ2YWJsZS5zdWJzY3JpYmUob2JzZXJ2ZXIpO1xuXG4gICAgbGV0IGkgPSAwO1xuICAgIHdoaWxlICgxKSB7XG4gICAgICBpZiAob2JzZXJ2ZXIudmFsdWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgeWllbGQgYXdhaXQgdGhpcy5fc2VsZWN0b3Iob2JzZXJ2ZXIudmFsdWVzLnNoaWZ0KCksIGkrKyk7XG4gICAgICB9IGVsc2UgaWYgKG9ic2VydmVyLmNsb3NlZCkge1xuICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgaWYgKG9ic2VydmVyLmhhc0Vycm9yKSB7XG4gICAgICAgICAgdGhyb3cgb2JzZXJ2ZXIuZXJyb3JWYWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgdHlwZSBBc3luY0l0ZXJhYmxlSW5wdXQ8VFNvdXJjZT4gPVxuICBJdGVyYWJsZTxUU291cmNlIHwgUHJvbWlzZUxpa2U8VFNvdXJjZT4+IHxcbiAgQXN5bmNJdGVyYWJsZTxUU291cmNlPiB8XG4gIEFycmF5TGlrZTxUU291cmNlPiB8XG4gIFByb21pc2VMaWtlPFRTb3VyY2U+IHxcbiAgT2JzZXJ2YWJsZTxUU291cmNlPjtcblxuZnVuY3Rpb24gaXNQcm9taXNlKHg6IGFueSk6IHggaXMgUHJvbWlzZUxpa2U8YW55PiB7XG4gIHJldHVybiB4ICE9IG51bGwgJiYgT2JqZWN0KHgpID09PSB4ICYmIHR5cGVvZiB4Wyd0aGVuJ10gPT09ICdmdW5jdGlvbic7XG59XG5cbmZ1bmN0aW9uIGlzT2JzZXJ2YWJsZSh4OiBhbnkpOiB4IGlzIE9ic2VydmFibGU8YW55PiB7XG4gIHJldHVybiB4ICE9IG51bGwgJiYgT2JqZWN0KHgpID09PSB4ICYmIHR5cGVvZiB4WydzdWJzY3JpYmUnXSA9PT0gJ2Z1bmN0aW9uJztcbn1cblxuZnVuY3Rpb24gaXNBcnJheUxpa2UoeDogYW55KTogeCBpcyBBcnJheUxpa2U8YW55PiB7XG4gIHJldHVybiB4ICE9IG51bGwgJiYgT2JqZWN0KHgpID09PSB4ICYmIHR5cGVvZiB4WydsZW5ndGgnXSA9PT0gJ251bWJlcic7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPihcbiAgICBzb3VyY2U6IEFzeW5jSXRlcmFibGVJbnB1dDxUU291cmNlPixcbiAgICBzZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0PiA9IGlkZW50aXR5QXN5bmMsXG4gICAgdGhpc0FyZz86IGFueSk6IEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgY29uc3QgZm4gPSBiaW5kQ2FsbGJhY2soc2VsZWN0b3IsIHRoaXNBcmcsIDIpO1xuICBpZiAoaXNJdGVyYWJsZShzb3VyY2UpIHx8IGlzQXN5bmNJdGVyYWJsZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tQXN5bmNJdGVyYWJsZTxUU291cmNlLCBUUmVzdWx0Pihzb3VyY2UsIGZuKTtcbiAgfVxuICBpZiAoaXNQcm9taXNlKHNvdXJjZSkpIHtcbiAgICByZXR1cm4gbmV3IEZyb21Qcm9taXNlSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdD4oc291cmNlLCBmbik7XG4gIH1cbiAgaWYgKGlzT2JzZXJ2YWJsZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tT2JzZXJ2YWJsZUFzeW5jSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdD4oc291cmNlLCBmbik7XG4gIH1cbiAgaWYgKGlzQXJyYXlMaWtlKHNvdXJjZSkpIHtcbiAgICByZXR1cm4gbmV3IEZyb21BcnJheUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQ+KHNvdXJjZSwgZm4pO1xuICB9XG5cbiAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW5wdXQgdHlwZSBub3Qgc3VwcG9ydGVkJyk7XG59XG4iXX0=
