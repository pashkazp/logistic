import * as tslib_1 from "tslib";
import { AsyncIterableX } from '../asynciterable';
import { sleep } from './_sleep';
export class TimeoutError extends Error {
    constructor() {
        super();
        Object.setPrototypeOf(this, TimeoutError.prototype);
        this.message = 'Timeout has occurred';
    }
}
const VALUE_TYPE = 'value';
const ERROR_TYPE = 'error';
class TimeoutAsyncIterable extends AsyncIterableX {
    constructor(source, dueTime) {
        super();
        this._source = source;
        this._dueTime = dueTime;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            const it = this._source[Symbol.asyncIterator]();
            while (1) {
                const { type, value } = yield tslib_1.__await(Promise.race([
                    it.next().then(value => { return { type: VALUE_TYPE, value }; }),
                    sleep(this._dueTime).then(() => { return { type: ERROR_TYPE }; })
                ]));
                if (type === ERROR_TYPE) {
                    throw new TimeoutError();
                }
                if (value.done) {
                    break;
                }
                yield value.value;
            }
        });
    }
}
export function timeout(source, dueTime) {
    return new TimeoutAsyncIterable(source, dueTime);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzeW5jaXRlcmFibGUvdGltZW91dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsTUFBTSxtQkFBb0IsU0FBUSxLQUFLO0lBQ3JDO1FBQ0UsS0FBSyxFQUFFLENBQUM7UUFDUixNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQztJQUN4QyxDQUFDO0NBQ0Y7QUFFRCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUM7QUFDM0IsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDO0FBTzNCLDBCQUFvQyxTQUFRLGNBQXVCO0lBSWpFLFlBQVksTUFBOEIsRUFBRSxPQUFlO1FBQ3pELEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDMUIsQ0FBQztJQUVNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQzs7WUFDM0IsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUNoRCxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUNULE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsc0JBQU0sT0FBTyxDQUFDLElBQUksQ0FBNEI7b0JBQ3BFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxNQUFNLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2hFLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNsRSxDQUFDLENBQUEsQ0FBQztnQkFFSCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQztvQkFDeEIsTUFBTSxJQUFJLFlBQVksRUFBRSxDQUFDO2dCQUMzQixDQUFDO2dCQUVELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUFDLEtBQUssQ0FBQztnQkFBQyxDQUFDO2dCQUMxQixNQUFNLEtBQUssQ0FBQyxLQUFLLENBQUM7WUFDcEIsQ0FBQztRQUNILENBQUM7S0FBQTtDQUNGO0FBRUQsTUFBTSxrQkFDRixNQUE4QixFQUM5QixPQUFlO0lBQ2pCLE1BQU0sQ0FBQyxJQUFJLG9CQUFvQixDQUFVLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM1RCxDQUFDIiwiZmlsZSI6ImFzeW5jaXRlcmFibGUvdGltZW91dC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzeW5jSXRlcmFibGVYIH0gZnJvbSAnLi4vYXN5bmNpdGVyYWJsZSc7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gJy4vX3NsZWVwJztcblxuZXhwb3J0IGNsYXNzIFRpbWVvdXRFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YodGhpcywgVGltZW91dEVycm9yLnByb3RvdHlwZSk7XG4gICAgdGhpcy5tZXNzYWdlID0gJ1RpbWVvdXQgaGFzIG9jY3VycmVkJztcbiAgfVxufVxuXG5jb25zdCBWQUxVRV9UWVBFID0gJ3ZhbHVlJztcbmNvbnN0IEVSUk9SX1RZUEUgPSAnZXJyb3InO1xuXG5pbnRlcmZhY2UgVGltZW91dE9wZXJhdGlvbjxUPiB7XG4gIHR5cGU6IHN0cmluZztcbiAgdmFsdWU/OiBJdGVyYXRvclJlc3VsdDxUPjtcbn1cblxuY2xhc3MgVGltZW91dEFzeW5jSXRlcmFibGU8VFNvdXJjZT4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUU291cmNlPiB7XG4gIHByaXZhdGUgX3NvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfZHVlVGltZTogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPiwgZHVlVGltZTogbnVtYmVyKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zb3VyY2UgPSBzb3VyY2U7XG4gICAgdGhpcy5fZHVlVGltZSA9IGR1ZVRpbWU7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBjb25zdCBpdCA9IHRoaXMuX3NvdXJjZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTtcbiAgICB3aGlsZSAoMSkge1xuICAgICAgY29uc3QgeyB0eXBlLCB2YWx1ZSB9ID0gYXdhaXQgUHJvbWlzZS5yYWNlPFRpbWVvdXRPcGVyYXRpb248VFNvdXJjZT4+KFtcbiAgICAgICAgaXQubmV4dCgpLnRoZW4odmFsdWUgPT4geyByZXR1cm4geyB0eXBlOiBWQUxVRV9UWVBFLCB2YWx1ZSB9OyB9KSxcbiAgICAgICAgc2xlZXAodGhpcy5fZHVlVGltZSkudGhlbigoKSA9PiB7IHJldHVybiB7IHR5cGU6IEVSUk9SX1RZUEUgfTsgfSlcbiAgICAgIF0pO1xuXG4gICAgICBpZiAodHlwZSA9PT0gRVJST1JfVFlQRSkge1xuICAgICAgICB0aHJvdyBuZXcgVGltZW91dEVycm9yKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh2YWx1ZS5kb25lKSB7IGJyZWFrOyB9XG4gICAgICB5aWVsZCB2YWx1ZS52YWx1ZTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRpbWVvdXQ8VFNvdXJjZT4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgIGR1ZVRpbWU6IG51bWJlcik6IEFzeW5jSXRlcmFibGVYPFRTb3VyY2U+IHtcbiAgcmV0dXJuIG5ldyBUaW1lb3V0QXN5bmNJdGVyYWJsZTxUU291cmNlPihzb3VyY2UsIGR1ZVRpbWUpO1xufSJdfQ==
