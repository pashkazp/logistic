import * as tslib_1 from "tslib";
import { AsyncIterableX } from '../asynciterable';
class RaceAsyncIterable extends AsyncIterableX {
    constructor(left, right) {
        super();
        this._left = left;
        this._right = right;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            const leftIt = this._left[Symbol.asyncIterator](), rightIt = this._right[Symbol.asyncIterator]();
            let leftWins = false, rightWins = false;
            const { value, done } = yield tslib_1.__await(Promise.race([
                leftIt.next().then(x => { leftWins = true; return x; }),
                rightIt.next().then(x => { rightWins = true; return x; }),
            ]));
            if (!done) {
                yield value;
            }
            let resultIterator, otherIterator;
            if (leftWins) {
                resultIterator = leftIt;
                otherIterator = rightIt;
            }
            else {
                resultIterator = rightIt;
                otherIterator = leftIt;
            }
            // Cancel/finish other iterator
            if (otherIterator.return) {
                yield tslib_1.__await(otherIterator.return());
            }
            let next;
            while (!(next = yield tslib_1.__await(resultIterator.next())).done) {
                yield next.value;
            }
        });
    }
}
/**
 * Propagates the async sequence that reacts first.
 * @param {AsyncIterable<T>} left First async sequence.
 * @param {AsyncIterable<T>} right Second async sequence.
 * @return {AsyncIterable<T>} An async sequence that surfaces either of the given sequences, whichever reacted first.
 */
export function race(left, right) {
    return new RaceAsyncIterable(left, right);
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzeW5jaXRlcmFibGUvcmFjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWxELHVCQUFpQyxTQUFRLGNBQXVCO0lBSTlELFlBQVksSUFBNEIsRUFBRSxLQUE2QjtRQUNyRSxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBQ3RCLENBQUM7SUFFTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7O1lBQzNCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDakcsSUFBSSxRQUFRLEdBQUcsS0FBSyxFQUFFLFNBQVMsR0FBRyxLQUFLLENBQUM7WUFDeEMsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxzQkFBTSxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUN6QyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkQsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDMUQsQ0FBQyxDQUFBLENBQUM7WUFFSCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsTUFBTSxLQUFLLENBQUM7WUFDZCxDQUFDO1lBRUQsSUFBSSxjQUFzQyxFQUFFLGFBQXFDLENBQUM7WUFDbEYsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDYixjQUFjLEdBQUcsTUFBTSxDQUFDO2dCQUN4QixhQUFhLEdBQUcsT0FBTyxDQUFDO1lBQzFCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixjQUFjLEdBQUcsT0FBTyxDQUFDO2dCQUN6QixhQUFhLEdBQUcsTUFBTSxDQUFDO1lBQ3pCLENBQUM7WUFFRCwrQkFBK0I7WUFDL0IsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQUMsc0JBQU0sYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFBLENBQUM7WUFBQyxDQUFDO1lBRTNELElBQUksSUFBSSxDQUFDO1lBQ1QsT0FBTyxDQUFDLENBQUMsSUFBSSxHQUFHLHNCQUFNLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xELE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQztZQUNuQixDQUFDO1FBQ0gsQ0FBQztLQUFBO0NBQ0Y7QUFFRDs7Ozs7R0FLRztBQUNILE1BQU0sZUFDRixJQUE0QixFQUM1QixLQUE2QjtJQUMvQixNQUFNLENBQUMsSUFBSSxpQkFBaUIsQ0FBVSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDckQsQ0FBQyIsImZpbGUiOiJhc3luY2l0ZXJhYmxlL3JhY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3luY0l0ZXJhYmxlWCB9IGZyb20gJy4uL2FzeW5jaXRlcmFibGUnO1xuXG5jbGFzcyBSYWNlQXN5bmNJdGVyYWJsZTxUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRTb3VyY2U+IHtcbiAgcHJpdmF0ZSBfbGVmdDogQXN5bmNJdGVyYWJsZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfcmlnaHQ6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT47XG5cbiAgY29uc3RydWN0b3IobGVmdDogQXN5bmNJdGVyYWJsZTxUU291cmNlPiwgcmlnaHQ6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2xlZnQgPSBsZWZ0O1xuICAgIHRoaXMuX3JpZ2h0ID0gcmlnaHQ7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBjb25zdCBsZWZ0SXQgPSB0aGlzLl9sZWZ0W1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpLCByaWdodEl0ID0gdGhpcy5fcmlnaHRbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk7XG4gICAgbGV0IGxlZnRXaW5zID0gZmFsc2UsIHJpZ2h0V2lucyA9IGZhbHNlO1xuICAgIGNvbnN0IHsgdmFsdWUsIGRvbmUgfSA9IGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICBsZWZ0SXQubmV4dCgpLnRoZW4oeCA9PiB7IGxlZnRXaW5zID0gdHJ1ZTsgcmV0dXJuIHg7IH0pLFxuICAgICAgcmlnaHRJdC5uZXh0KCkudGhlbih4ID0+IHsgcmlnaHRXaW5zID0gdHJ1ZTsgcmV0dXJuIHg7IH0pLFxuICAgIF0pO1xuXG4gICAgaWYgKCFkb25lKSB7XG4gICAgICB5aWVsZCB2YWx1ZTtcbiAgICB9XG5cbiAgICBsZXQgcmVzdWx0SXRlcmF0b3I6IEFzeW5jSXRlcmF0b3I8VFNvdXJjZT4sIG90aGVySXRlcmF0b3I6IEFzeW5jSXRlcmF0b3I8VFNvdXJjZT47XG4gICAgaWYgKGxlZnRXaW5zKSB7XG4gICAgICByZXN1bHRJdGVyYXRvciA9IGxlZnRJdDtcbiAgICAgIG90aGVySXRlcmF0b3IgPSByaWdodEl0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHRJdGVyYXRvciA9IHJpZ2h0SXQ7XG4gICAgICBvdGhlckl0ZXJhdG9yID0gbGVmdEl0O1xuICAgIH1cblxuICAgIC8vIENhbmNlbC9maW5pc2ggb3RoZXIgaXRlcmF0b3JcbiAgICBpZiAob3RoZXJJdGVyYXRvci5yZXR1cm4pIHsgYXdhaXQgb3RoZXJJdGVyYXRvci5yZXR1cm4oKTsgfVxuXG4gICAgbGV0IG5leHQ7XG4gICAgd2hpbGUgKCEobmV4dCA9IGF3YWl0IHJlc3VsdEl0ZXJhdG9yLm5leHQoKSkuZG9uZSkge1xuICAgICAgeWllbGQgbmV4dC52YWx1ZTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBQcm9wYWdhdGVzIHRoZSBhc3luYyBzZXF1ZW5jZSB0aGF0IHJlYWN0cyBmaXJzdC5cbiAqIEBwYXJhbSB7QXN5bmNJdGVyYWJsZTxUPn0gbGVmdCBGaXJzdCBhc3luYyBzZXF1ZW5jZS5cbiAqIEBwYXJhbSB7QXN5bmNJdGVyYWJsZTxUPn0gcmlnaHQgU2Vjb25kIGFzeW5jIHNlcXVlbmNlLlxuICogQHJldHVybiB7QXN5bmNJdGVyYWJsZTxUPn0gQW4gYXN5bmMgc2VxdWVuY2UgdGhhdCBzdXJmYWNlcyBlaXRoZXIgb2YgdGhlIGdpdmVuIHNlcXVlbmNlcywgd2hpY2hldmVyIHJlYWN0ZWQgZmlyc3QuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByYWNlPFRTb3VyY2U+KFxuICAgIGxlZnQ6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgcmlnaHQ6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pOiBBc3luY0l0ZXJhYmxlWDxUU291cmNlPiB7XG4gIHJldHVybiBuZXcgUmFjZUFzeW5jSXRlcmFibGU8VFNvdXJjZT4obGVmdCwgcmlnaHQpO1xufVxuIl19
