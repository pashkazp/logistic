goog.module('targets.es2015.cls.asynciterable.publish'); exports = {}; var module = {id: 'targets/es2015/cls/asynciterable/publish.js'};/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

var asynciterable_1 = goog.require('targets.es2015.cls.asynciterable');
const tsickle_forward_declare_1 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable");
var _refcountlist_1 = goog.require('targets.es2015.cls.iterable._refcountlist');
const tsickle_forward_declare_2 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.iterable._refcountlist");
var create_1 = goog.require('targets.es2015.cls.asynciterable.create');
const tsickle_forward_declare_3 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable.create");
/**
 * @template T
 */
class PublishedAsyncBuffer extends asynciterable_1.AsyncIterableX {
    /**
     * @param {!AsyncIterator<T>} source
     */
    constructor(source) {
        super();
        this._stopped = false;
        this._source = source;
        this._buffer = new _refcountlist_1.RefCountList(0);
    }
    /**
     * @param {number} i
     * @return {!AsyncIterable<T>}
     */
    _getIterable(i) {
        return __asyncGenerator(this, arguments, function* _getIterable_1() {
            try {
                while (1) {
                    let /** @type {boolean} */ hasValue = false, /** @type {T} */ current = ({});
                    if (i >= this._buffer.count) {
                        if (!this._stopped) {
                            try {
                                let /** @type {!IteratorResult<T>} */ next = yield __await(this._source.next());
                                hasValue = !next.done;
                                if (hasValue) {
                                    current = next.value;
                                }
                            }
                            catch (e) {
                                this._error = e;
                                this._stopped = true;
                            }
                        }
                        if (this._stopped) {
                            if (this._error) {
                                throw this._error;
                            }
                            else {
                                break;
                            }
                        }
                        if (hasValue) {
                            this._buffer.push(current);
                        }
                    }
                    else {
                        hasValue = true;
                    }
                    if (hasValue) {
                        yield this._buffer.get(i);
                    }
                    else {
                        break;
                    }
                    i++;
                }
            }
            finally {
                this._buffer.done();
            }
        });
    }
    /**
     * @return {!AsyncIterator<T>}
     */
    [Symbol.asyncIterator]() {
        this._buffer.readerCount++;
        return this._getIterable(this._buffer.count)[Symbol.asyncIterator]();
    }
}
function PublishedAsyncBuffer_tsickle_Closure_declarations() {
    /** @type {!tsickle_forward_declare_2.RefCountList<T>} */
    PublishedAsyncBuffer.prototype._buffer;
    /** @type {!AsyncIterator<T>} */
    PublishedAsyncBuffer.prototype._source;
    /** @type {?} */
    PublishedAsyncBuffer.prototype._error;
    /** @type {boolean} */
    PublishedAsyncBuffer.prototype._stopped;
}
/**
 * @template TSource, TResult
 * @param {!AsyncIterable<TSource>} source
 * @param {function(!AsyncIterable<TSource>): !AsyncIterable<TResult>=} selector
 * @return {!tsickle_forward_declare_1.AsyncIterableX<(TSource|TResult)>}
 */
function publish(source, selector) {
    return selector ?
        create_1.create(() => __awaiter(this, void 0, void 0, function* () { return selector(publish(source))[Symbol.asyncIterator](); })) :
        new PublishedAsyncBuffer(source[Symbol.asyncIterator]());
}
exports.publish = publish;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hc3luY2l0ZXJhYmxlL3B1Ymxpc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILG9EQUx1QjtBQU12QixNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsMkNBQTJDLENBQUMsQ0FOaEQ7QUFPbEQsNkRBTnFCO0FBT3JCLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvREFBb0QsQ0FBQyxDQVBsRDtBQVF6RCxxQ0FQZTtBQVFmLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQzFHOztHQUVHO0FBVEgsMEJBQTZCLFNBQVEsOEJBQWtCO0lBZXZEOztPQUVHO0lBWEQsWUFBWSxNQUF3QjtRQWFsQyxLQVpLLEVBQUUsQ0FBQztRQUhILGFBQVMsR0FBVyxLQUFNLENBQUE7UUFnQi9CLElBWkksQ0FBQyxPQUFPLEdBQUUsTUFBTyxDQUFDO1FBYXRCLElBWkksQ0FBQyxPQUFPLEdBQUUsSUFBSSw0QkFBYSxDQUFJLENBQUMsQ0FBQyxDQUFDO0lBYXhDLENBQUM7SUFDSDs7O09BR0c7SUFkYyxZQUFZLENBQUMsQ0FBUzs7WUFpQm5DLElBaEJHLENBQUU7Z0JBaUJILE9BaEJPLENBQUMsRUFBQyxDQUFFO29CQWlCVCxJQUFJLHNCQWhCRCxDQUFBLFFBQVMsR0FBRSxLQUFNLEVBQUEsZ0JBQUMsQ0FBQSxPQUFRLEdBQUEsQ0FBTSxFQUFBLENBQUUsQ0FBQztvQkFpQnRDLEVBQUUsQ0FBQyxDQWhCQyxDQUFDLElBQUcsSUFBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFFO3dCQWlCNUIsRUFBRSxDQUFDLENBaEJDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUU7NEJBaUJuQixJQWhCRyxDQUFFO2dDQWlCSCxJQUFJLGlDQWhCRCxDQUFBLElBQUssR0FBRSxjQUFNLElBQUssQ0FB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dmVydmlldyBhZGRlZCBieSB0c2lja2xlXG4gKiBAc3VwcHJlc3Mge2NoZWNrVHlwZXN9IGNoZWNrZWQgYnkgdHNjXG4gKi9cblxuaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVggfSBmcm9tICcuLi9hc3luY2l0ZXJhYmxlJztcbmNvbnN0IHRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzEgPSBnb29nLmZvcndhcmREZWNsYXJlKFwiX1VzZXJzLnB0YXlsb3IuZGV2Lml4anMuc3JjLmFzeW5jaXRlcmFibGVcIik7XG5pbXBvcnQgeyBSZWZDb3VudExpc3QgfSBmcm9tICcuLi9pdGVyYWJsZS9fcmVmY291bnRsaXN0JztcbmNvbnN0IHRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzIgPSBnb29nLmZvcndhcmREZWNsYXJlKFwiX1VzZXJzLnB0YXlsb3IuZGV2Lml4anMuc3JjLml0ZXJhYmxlLl9yZWZjb3VudGxpc3RcIik7XG5pbXBvcnQgeyBjcmVhdGUgfSBmcm9tICcuL2NyZWF0ZSc7XG5jb25zdCB0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8zID0gZ29vZy5mb3J3YXJkRGVjbGFyZShcIl9Vc2Vycy5wdGF5bG9yLmRldi5peGpzLnNyYy5hc3luY2l0ZXJhYmxlLmNyZWF0ZVwiKTtcbi8qKlxuICogQHRlbXBsYXRlIFRcbiAqL1xuY2xhc3MgUHVibGlzaGVkQXN5bmNCdWZmZXI8VD4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUPiB7XG5wcml2YXRlIF9idWZmZXI6IFJlZkNvdW50TGlzdDxUPjtcbnByaXZhdGUgX3NvdXJjZTogQXN5bmNJdGVyYXRvcjxUPjtcbnByaXZhdGUgX2Vycm9yOiBhbnk7XG5wcml2YXRlIF9zdG9wcGVkOiBib29sZWFuID0gZmFsc2U7XG4vKipcbiAqIEBwYXJhbSB7IUFzeW5jSXRlcmF0b3I8VD59IHNvdXJjZVxuICovXG5jb25zdHJ1Y3Rvcihzb3VyY2U6IEFzeW5jSXRlcmF0b3I8VD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9idWZmZXIgPSBuZXcgUmVmQ291bnRMaXN0PFQ+KDApO1xuICB9XG4vKipcbiAqIEBwYXJhbSB7bnVtYmVyfSBpXG4gKiBAcmV0dXJuIHshQXN5bmNJdGVyYWJsZTxUPn1cbiAqL1xuXG5wcml2YXRlIGFzeW5jICpfZ2V0SXRlcmFibGUoaTogbnVtYmVyKTogQXN5bmNJdGVyYWJsZTxUPiB7XG4gICAgdHJ5IHtcbiAgICAgIHdoaWxlICgxKSB7XG4gICAgICAgIGxldCAvKiogQHR5cGUge2Jvb2xlYW59ICovIGhhc1ZhbHVlID0gZmFsc2UsIC8qKiBAdHlwZSB7VH0gKi8gY3VycmVudCA9IC8qKiBAdHlwZSB7VH0gKi8oKCA8VD57fSkpO1xuICAgICAgICBpZiAoaSA+PSB0aGlzLl9idWZmZXIuY291bnQpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX3N0b3BwZWQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGxldCAvKiogQHR5cGUgeyFJdGVyYXRvclJlc3VsdDxUPn0gKi8gbmV4dCA9IGF3YWl0IHRoaXMuX3NvdXJjZS5uZXh0KCk7XG4gICAgICAgICAgICAgIGhhc1ZhbHVlID0gIW5leHQuZG9uZTtcbiAgICAgICAgICAgICAgaWYgKGhhc1ZhbHVlKSB7IGN1cnJlbnQgPSBuZXh0LnZhbHVlOyB9XG4gICAgICAgICAgICB9IGNhdGNoICggLyoqIEB0eXBlIHs/fSAqL2UpIHtcbiAgICAgICAgICAgICAgdGhpcy5fZXJyb3IgPSBlO1xuICAgICAgICAgICAgICB0aGlzLl9zdG9wcGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAodGhpcy5fc3RvcHBlZCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX2Vycm9yKSB7XG4gICAgICAgICAgICAgIHRocm93IHRoaXMuX2Vycm9yO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGhhc1ZhbHVlKSB7IHRoaXMuX2J1ZmZlci5wdXNoKGN1cnJlbnQpOyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGFzVmFsdWUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc1ZhbHVlKSB7XG4gICAgICAgICAgeWllbGQgdGhpcy5fYnVmZmVyLmdldChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5fYnVmZmVyLmRvbmUoKTtcbiAgICB9XG4gIH1cbi8qKlxuICogQHJldHVybiB7IUFzeW5jSXRlcmF0b3I8VD59XG4gKi9cbltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTogQXN5bmNJdGVyYXRvcjxUPiB7XG4gICAgdGhpcy5fYnVmZmVyLnJlYWRlckNvdW50Kys7XG4gICAgcmV0dXJuIHRoaXMuX2dldEl0ZXJhYmxlKHRoaXMuX2J1ZmZlci5jb3VudClbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gUHVibGlzaGVkQXN5bmNCdWZmZXJfdHNpY2tsZV9DbG9zdXJlX2RlY2xhcmF0aW9ucygpIHtcbi8qKiBAdHlwZSB7IXRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzIuUmVmQ291bnRMaXN0PFQ+fSAqL1xuUHVibGlzaGVkQXN5bmNCdWZmZXIucHJvdG90eXBlLl9idWZmZXI7XG4vKiogQHR5cGUgeyFBc3luY0l0ZXJhdG9yPFQ+fSAqL1xuUHVibGlzaGVkQXN5bmNCdWZmZXIucHJvdG90eXBlLl9zb3VyY2U7XG4vKiogQHR5cGUgez99ICovXG5QdWJsaXNoZWRBc3luY0J1ZmZlci5wcm90b3R5cGUuX2Vycm9yO1xuLyoqIEB0eXBlIHtib29sZWFufSAqL1xuUHVibGlzaGVkQXN5bmNCdWZmZXIucHJvdG90eXBlLl9zdG9wcGVkO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBwdWJsaXNoPFRTb3VyY2U+KHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPik6IEFzeW5jSXRlcmFibGVYPFRTb3VyY2U+O1xuZXhwb3J0IGZ1bmN0aW9uIHB1Ymxpc2g8VFNvdXJjZSwgVFJlc3VsdD4oXG4gIHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPixcbiAgc2VsZWN0b3I/OiAodmFsdWU6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pID0+IEFzeW5jSXRlcmFibGU8VFJlc3VsdD4pOiBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0Pjtcbi8qKlxuICogQHRlbXBsYXRlIFRTb3VyY2UsIFRSZXN1bHRcbiAqIEBwYXJhbSB7IUFzeW5jSXRlcmFibGU8VFNvdXJjZT59IHNvdXJjZVxuICogQHBhcmFtIHtmdW5jdGlvbighQXN5bmNJdGVyYWJsZTxUU291cmNlPik6ICFBc3luY0l0ZXJhYmxlPFRSZXN1bHQ+PX0gc2VsZWN0b3JcbiAqIEByZXR1cm4geyF0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8xLkFzeW5jSXRlcmFibGVYPChUU291cmNlfFRSZXN1bHQpPn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHB1Ymxpc2g8VFNvdXJjZSwgVFJlc3VsdD4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgIHNlbGVjdG9yPzogKHZhbHVlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KSA9PiBBc3luY0l0ZXJhYmxlPFRSZXN1bHQ+KTogQXN5bmNJdGVyYWJsZVg8VFNvdXJjZSB8IFRSZXN1bHQ+IHtcbiAgcmV0dXJuIHNlbGVjdG9yID9cbiAgICBjcmVhdGUoYXN5bmMgKCkgPT4gc2VsZWN0b3IocHVibGlzaChzb3VyY2UpKVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSkgOlxuICAgIG5ldyBQdWJsaXNoZWRBc3luY0J1ZmZlcjxUU291cmNlPihzb3VyY2VbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkpO1xufVxuIl19