Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const asynciterable_1 = require("../asynciterable");
const toarray_1 = require("./toarray");
const sorter_1 = require("../internal/sorter");
class OrderedAsyncIterableBaseX extends asynciterable_1.AsyncIterableX {
    constructor(source) {
        super();
        this._source = source;
    }
    [Symbol.asyncIterator]() {
        return tslib_1.__asyncGenerator(this, arguments, function* _a() {
            const array = yield tslib_1.__await(toarray_1.toArray(this._source));
            const len = array.length;
            const indices = new Array(len);
            for (let i = 0, len = array.length; i < len; i++) {
                indices[i] = i;
            }
            indices.sort(this._getSorter(array));
            for (const index of indices) {
                yield array[index];
            }
        });
    }
    thenBy(keySelector, comparer = sorter_1.sorter) {
        /* tslint:disable-next-line: no-use-before-declare */
        return new OrderedAsyncIterableX(this._source, keySelector, comparer, false, this);
    }
    thenByDescending(keySelector, comparer = sorter_1.sorter) {
        /* tslint:disable-next-line: no-use-before-declare */
        return new OrderedAsyncIterableX(this._source, keySelector, comparer, true, this);
    }
}
exports.OrderedAsyncIterableBaseX = OrderedAsyncIterableBaseX;
class OrderedAsyncIterableX extends OrderedAsyncIterableBaseX {
    constructor(source, keySelector, comparer, descending, parent) {
        super(source);
        this._keySelector = keySelector;
        this._comparer = comparer;
        this._descending = descending;
        this._parent = parent;
    }
    _getSorter(elements, next) {
        const keys = elements.map(this._keySelector);
        const comparer = this._comparer;
        const parent = this._parent;
        const descending = this._descending;
        const sorter = (x, y) => {
            const result = comparer(keys[x], keys[y]);
            if (result === 0) {
                return next ? next(x, y) : x - y;
            }
            return descending ? -result : result;
        };
        return parent ? parent._getSorter(elements, sorter) : sorter;
    }
}
exports.OrderedAsyncIterableX = OrderedAsyncIterableX;
function orderBy(source, keySelector, comparer = sorter_1.sorter) {
    return new OrderedAsyncIterableX(source, keySelector, comparer, false);
}
exports.orderBy = orderBy;
function orderByDescending(source, keySelector, comparer = sorter_1.sorter) {
    return new OrderedAsyncIterableX(source, keySelector, comparer, true);
}
exports.orderByDescending = orderByDescending;
function thenBy(source, keySelector, comparer = sorter_1.sorter) {
    return new OrderedAsyncIterableX(source._source, keySelector, comparer, false, source);
}
exports.thenBy = thenBy;
function thenByDescending(source, keySelector, comparer = sorter_1.sorter) {
    return new OrderedAsyncIterableX(source._source, keySelector, comparer, true, source);
}
exports.thenByDescending = thenByDescending;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzeW5jaXRlcmFibGUvb3JkZXJieS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9EQUFrRDtBQUNsRCx1Q0FBb0M7QUFDcEMsK0NBQTZEO0FBRTdELCtCQUF5RCxTQUFRLDhCQUF1QjtJQUd0RixZQUFZLE1BQThCO1FBQ3hDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7SUFDeEIsQ0FBQztJQUVNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQzs7WUFDM0IsTUFBTSxLQUFLLEdBQUcsc0JBQU0saUJBQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQztZQUMxQyxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ3pCLE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxDQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ2pELE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakIsQ0FBQztZQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLE1BQU0sS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JCLENBQUM7UUFDSCxDQUFDO0tBQUE7SUFFRCxNQUFNLENBQ0YsV0FBb0MsRUFDcEMsV0FBNkMsZUFBYTtRQUM1RCxxREFBcUQ7UUFDckQsTUFBTSxDQUFDLElBQUkscUJBQXFCLENBQWdCLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVB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bGUvb3JkZXJieS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzeW5jSXRlcmFibGVYIH0gZnJvbSAnLi4vYXN5bmNpdGVyYWJsZSc7XG5pbXBvcnQgeyB0b0FycmF5IH0gZnJvbSAnLi90b2FycmF5JztcbmltcG9ydCB7IHNvcnRlciBhcyBkZWZhdWx0U29ydGVyIH0gZnJvbSAnLi4vaW50ZXJuYWwvc29ydGVyJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE9yZGVyZWRBc3luY0l0ZXJhYmxlQmFzZVg8VFNvdXJjZT4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUU291cmNlPiB7XG4gIF9zb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT47XG5cbiAgY29uc3RydWN0b3Ioc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zb3VyY2UgPSBzb3VyY2U7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBjb25zdCBhcnJheSA9IGF3YWl0IHRvQXJyYXkodGhpcy5fc291cmNlKTtcbiAgICBjb25zdCBsZW4gPSBhcnJheS5sZW5ndGg7XG4gICAgY29uc3QgaW5kaWNlcyA9IG5ldyBBcnJheTxudW1iZXI+KGxlbik7XG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBpbmRpY2VzW2ldID0gaTtcbiAgICB9XG5cbiAgICBpbmRpY2VzLnNvcnQodGhpcy5fZ2V0U29ydGVyKGFycmF5KSk7XG4gICAgZm9yIChjb25zdCBpbmRleCBvZiBpbmRpY2VzKSB7XG4gICAgICB5aWVsZCBhcnJheVtpbmRleF07XG4gICAgfVxuICB9XG5cbiAgdGhlbkJ5PFRLZXk+KFxuICAgICAga2V5U2VsZWN0b3I6IChpdGVtOiBUU291cmNlKSA9PiBUS2V5LFxuICAgICAgY29tcGFyZXI6IChmc3Q6IFRLZXksIHNuZDogVEtleSkgPT4gbnVtYmVyID0gZGVmYXVsdFNvcnRlcik6IE9yZGVyZWRBc3luY0l0ZXJhYmxlQmFzZVg8VFNvdXJjZT4ge1xuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdXNlLWJlZm9yZS1kZWNsYXJlICovXG4gICAgcmV0dXJuIG5ldyBPcmRlcmVkQXN5bmNJdGVyYWJsZVg8VEtleSwgVFNvdXJjZT4odGhpcy5fc291cmNlLCBrZXlTZWxlY3RvciwgY29tcGFyZXIsIGZhbHNlLCB0aGlzKTtcbiAgfVxuXG4gIHRoZW5CeURlc2NlbmRpbmc8VEtleT4oXG4gICAgICBrZXlTZWxlY3RvcjogKGl0ZW06IFRTb3VyY2UpID0+IFRLZXksXG4gICAgICBjb21wYXJlcjogKGZzdDogVEtleSwgc25kOiBUS2V5KSA9PiBudW1iZXIgPSBkZWZhdWx0U29ydGVyKTogT3JkZXJlZEFzeW5jSXRlcmFibGVCYXNlWDxUU291cmNlPiB7XG4gICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby11c2UtYmVmb3JlLWRlY2xhcmUgKi9cbiAgICByZXR1cm4gbmV3IE9yZGVyZWRBc3luY0l0ZXJhYmxlWDxUS2V5LCBUU291cmNlPih0aGlzLl9zb3VyY2UsIGtleVNlbGVjdG9yLCBjb21wYXJlciwgdHJ1ZSwgdGhpcyk7XG4gIH1cblxuICBhYnN0cmFjdCBfZ2V0U29ydGVyKFxuICAgIGVsZW1lbnRzOiBUU291cmNlW10sXG4gICAgbmV4dD86ICh4OiBudW1iZXIsIHk6IG51bWJlcikgPT4gbnVtYmVyKTogKHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBPcmRlcmVkQXN5bmNJdGVyYWJsZVg8VEtleSwgVFNvdXJjZT4gZXh0ZW5kcyBPcmRlcmVkQXN5bmNJdGVyYWJsZUJhc2VYPFRTb3VyY2U+IHtcbiAgcHJpdmF0ZSBfa2V5U2VsZWN0b3I6IChpdGVtOiBUU291cmNlKSA9PiBUS2V5O1xuICBwcml2YXRlIF9jb21wYXJlcjogKGZzdDogVEtleSwgc25kOiBUS2V5KSA9PiBudW1iZXI7XG4gIHByaXZhdGUgX2Rlc2NlbmRpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgX3BhcmVudD86IE9yZGVyZWRBc3luY0l0ZXJhYmxlQmFzZVg8VFNvdXJjZT47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgICBrZXlTZWxlY3RvcjogKGl0ZW06IFRTb3VyY2UpID0+IFRLZXksXG4gICAgICBjb21wYXJlcjogKGZzdDogVEtleSwgc25kOiBUS2V5KSA9PiBudW1iZXIsXG4gICAgICBkZXNjZW5kaW5nOiBib29sZWFuLFxuICAgICAgcGFyZW50PzogT3JkZXJlZEFzeW5jSXRlcmFibGVCYXNlWDxUU291cmNlPikge1xuICAgIHN1cGVyKHNvdXJjZSk7XG4gICAgdGhpcy5fa2V5U2VsZWN0b3IgPSBrZXlTZWxlY3RvcjtcbiAgICB0aGlzLl9jb21wYXJlciA9IGNvbXBhcmVyO1xuICAgIHRoaXMuX2Rlc2NlbmRpbmcgPSBkZXNjZW5kaW5nO1xuICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudDtcbiAgfVxuXG4gIF9nZXRTb3J0ZXIoXG4gICAgICBlbGVtZW50czogVFNvdXJjZVtdLFxuICAgICAgbmV4dD86ICh4OiBudW1iZXIsIHk6IG51bWJlcikgPT4gbnVtYmVyKTogKHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiBudW1iZXIge1xuICAgIGNvbnN0IGtleXMgPSBlbGVtZW50cy5tYXAodGhpcy5fa2V5U2VsZWN0b3IpO1xuICAgIGNvbnN0IGNvbXBhcmVyID0gdGhpcy5fY29tcGFyZXI7XG4gICAgY29uc3QgcGFyZW50ID0gdGhpcy5fcGFyZW50O1xuICAgIGNvbnN0IGRlc2NlbmRpbmcgPSB0aGlzLl9kZXNjZW5kaW5nO1xuICAgIGNvbnN0IHNvcnRlciA9ICh4OiBudW1iZXIsIHk6IG51bWJlcik6IG51bWJlciA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBjb21wYXJlcihrZXlzW3hdLCBrZXlzW3ldKTtcbiAgICAgIGlmIChyZXN1bHQgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIG5leHQgPyBuZXh0KHgsIHkpIDogeCAtIHk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBkZXNjZW5kaW5nID8gLXJlc3VsdCA6IHJlc3VsdDtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHBhcmVudCA/IHBhcmVudC5fZ2V0U29ydGVyKGVsZW1lbnRzLCBzb3J0ZXIpIDogc29ydGVyO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvcmRlckJ5PFRLZXksIFRTb3VyY2U+KFxuICAgICAgc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgICAga2V5U2VsZWN0b3I6IChpdGVtOiBUU291cmNlKSA9PiBUS2V5LFxuICAgICAgY29tcGFyZXI6IChmc3Q6IFRLZXksIHNuZDogVEtleSkgPT4gbnVtYmVyID0gZGVmYXVsdFNvcnRlcik6IE9yZGVyZWRBc3luY0l0ZXJhYmxlWDxUS2V5LCBUU291cmNlPiB7XG4gIHJldHVybiBuZXcgT3JkZXJlZEFzeW5jSXRlcmFibGVYPFRLZXksIFRTb3VyY2U+KHNvdXJjZSwga2V5U2VsZWN0b3IsIGNvbXBhcmVyLCBmYWxzZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBvcmRlckJ5RGVzY2VuZGluZzxUS2V5LCBUU291cmNlPihcbiAgICAgIHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPixcbiAgICAgIGtleVNlbGVjdG9yOiAoaXRlbTogVFNvdXJjZSkgPT4gVEtleSxcbiAgICAgIGNvbXBhcmVyOiAoZnN0OiBUS2V5LCBzbmQ6IFRLZXkpID0+IG51bWJlciA9IGRlZmF1bHRTb3J0ZXIpOiBPcmRlcmVkQXN5bmNJdGVyYWJsZVg8VEtleSwgVFNvdXJjZT4ge1xuICByZXR1cm4gbmV3IE9yZGVyZWRBc3luY0l0ZXJhYmxlWDxUS2V5LCBUU291cmNlPihzb3VyY2UsIGtleVNlbGVjdG9yLCBjb21wYXJlciwgdHJ1ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0aGVuQnk8VEtleSwgVFNvdXJjZT4oXG4gICAgICBzb3VyY2U6IE9yZGVyZWRBc3luY0l0ZXJhYmxlQmFzZVg8VFNvdXJjZT4sXG4gICAgICBrZXlTZWxlY3RvcjogKGl0ZW06IFRTb3VyY2UpID0+IFRLZXksXG4gICAgICBjb21wYXJlcjogKGZzdDogVEtleSwgc25kOiBUS2V5KSA9PiBudW1iZXIgPSBkZWZhdWx0U29ydGVyKTogT3JkZXJlZEFzeW5jSXRlcmFibGVYPFRLZXksIFRTb3VyY2U+IHtcbiAgcmV0dXJuIG5ldyBPcmRlcmVkQXN5bmNJdGVyYWJsZVg8VEtleSwgVFNvdXJjZT4oc291cmNlLl9zb3VyY2UsIGtleVNlbGVjdG9yLCBjb21wYXJlciwgZmFsc2UsIHNvdXJjZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0aGVuQnlEZXNjZW5kaW5nPFRLZXksIFRTb3VyY2U+KFxuICAgICAgc291cmNlOiBPcmRlcmVkQXN5bmNJdGVyYWJsZUJhc2VYPFRTb3VyY2U+LFxuICAgICAga2V5U2VsZWN0b3I6IChpdGVtOiBUU291cmNlKSA9PiBUS2V5LFxuICAgICAgY29tcGFyZXI6IChmc3Q6IFRLZXksIHNuZDogVEtleSkgPT4gbnVtYmVyID0gZGVmYXVsdFNvcnRlcik6IE9yZGVyZWRBc3luY0l0ZXJhYmxlWDxUS2V5LCBUU291cmNlPiB7XG4gIHJldHVybiBuZXcgT3JkZXJlZEFzeW5jSXRlcmFibGVYPFRLZXksIFRTb3VyY2U+KHNvdXJjZS5fc291cmNlLCBrZXlTZWxlY3RvciwgY29tcGFyZXIsIHRydWUsIHNvdXJjZSk7XG59XG4iXX0=
