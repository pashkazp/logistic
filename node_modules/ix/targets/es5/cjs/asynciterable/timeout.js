Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var asynciterable_1 = require("../asynciterable");
var _sleep_1 = require("./_sleep");
var TimeoutError = (function (_super) {
    tslib_1.__extends(TimeoutError, _super);
    function TimeoutError() {
        var _this = _super.call(this) || this;
        Object.setPrototypeOf(_this, TimeoutError.prototype);
        _this.message = 'Timeout has occurred';
        return _this;
    }
    return TimeoutError;
}(Error));
exports.TimeoutError = TimeoutError;
var VALUE_TYPE = 'value';
var ERROR_TYPE = 'error';
var TimeoutAsyncIterable = (function (_super) {
    tslib_1.__extends(TimeoutAsyncIterable, _super);
    function TimeoutAsyncIterable(source, dueTime) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._dueTime = dueTime;
        return _this;
    }
    TimeoutAsyncIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var it, _a, type, value;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        it = this._source[Symbol.asyncIterator]();
                        _b.label = 1;
                    case 1:
                        if (!1) return [3 /*break*/, 4];
                        return [4 /*yield*/, tslib_1.__await(Promise.race([
                                it.next().then(function (value) { return { type: VALUE_TYPE, value: value }; }),
                                _sleep_1.sleep(this._dueTime).then(function () { return { type: ERROR_TYPE }; })
                            ]))];
                    case 2:
                        _a = _b.sent(), type = _a.type, value = _a.value;
                        if (type === ERROR_TYPE) {
                            throw new TimeoutError();
                        }
                        if (value.done) {
                            return [3 /*break*/, 4];
                        }
                        return [4 /*yield*/, value.value];
                    case 3:
                        _b.sent();
                        return [3 /*break*/, 1];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    return TimeoutAsyncIterable;
}(asynciterable_1.AsyncIterableX));
function timeout(source, dueTime) {
    return new TimeoutAsyncIterable(source, dueTime);
}
exports.timeout = timeout;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzeW5jaXRlcmFibGUvdGltZW91dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtEQUFrRDtBQUNsRCxtQ0FBaUM7QUFFakM7SUFBa0Msd0NBQUs7SUFDckM7UUFBQSxZQUNFLGlCQUFPLFNBR1I7UUFGQyxNQUFNLENBQUMsY0FBYyxDQUFDLEtBQUksRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDcEQsS0FBSSxDQUFDLE9BQU8sR0FBRyxzQkFBc0IsQ0FBQzs7SUFDeEMsQ0FBQztJQUNILG1CQUFDO0FBQUQsQ0FOQSxBQU1DLENBTmlDLEtBQUssR0FNdEM7QUFOWSxvQ0FBWTtBQVF6QixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUM7QUFDM0IsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDO0FBTzNCO0lBQTRDLGdEQUF1QjtJQUlqRSw4QkFBWSxNQUE4QixFQUFFLE9BQWU7UUFBM0QsWUFDRSxpQkFBTyxTQUdSO1FBRkMsS0FBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsS0FBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7O0lBQzFCLENBQUM7SUFFTSwrQkFBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQTdCOzs7Ozs7d0JBQ1EsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7Ozs2QkFDekMsQ0FBQzt3QkFDa0IscUNBQU0sT0FBTyxDQUFDLElBQUksQ0FBNEI7Z0NBQ3BFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQSxLQUFLLElBQU0sTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxLQUFLLE9BQUEsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dDQUNoRSxjQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFRLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzs2QkFDbEUsQ0FBQyxHQUFBOzt3QkFISSxLQUFrQixTQUd0QixFQUhNLElBQUksVUFBQSxFQUFFLEtBQUssV0FBQTt3QkFLbkIsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7NEJBQ3hCLE1BQU0sSUFBSSxZQUFZLEVBQUUsQ0FBQzt3QkFDM0IsQ0FBQzt3QkFFRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs0QkFBQyxNQUFNLGtCQUFBO3dCQUFDLENBQUM7d0JBQzFCLHFCQUFNLEtBQUssQ0FBQyxLQUFLLEVBQUE7O3dCQUFqQixTQUFpQixDQUFDOzs7Ozs7S0FFckI7SUFDSCwyQkFBQztBQUFELENBMUJBLEFBMEJDLENBMUIyQyw4QkFBYyxHQTBCekQ7QUFFRCxpQkFDSSxNQUE4QixFQUM5QixPQUFlO0lBQ2pCLE1BQU0sQ0FBQyxJQUFJLG9CQUFvQixDQUFVLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM1RCxDQUFDO0FBSkQsMEJBSUMiLCJmaWxlIjoiYXN5bmNpdGVyYWJsZS90aW1lb3V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVggfSBmcm9tICcuLi9hc3luY2l0ZXJhYmxlJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnLi9fc2xlZXAnO1xuXG5leHBvcnQgY2xhc3MgVGltZW91dEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBUaW1lb3V0RXJyb3IucHJvdG90eXBlKTtcbiAgICB0aGlzLm1lc3NhZ2UgPSAnVGltZW91dCBoYXMgb2NjdXJyZWQnO1xuICB9XG59XG5cbmNvbnN0IFZBTFVFX1RZUEUgPSAndmFsdWUnO1xuY29uc3QgRVJST1JfVFlQRSA9ICdlcnJvcic7XG5cbmludGVyZmFjZSBUaW1lb3V0T3BlcmF0aW9uPFQ+IHtcbiAgdHlwZTogc3RyaW5nO1xuICB2YWx1ZT86IEl0ZXJhdG9yUmVzdWx0PFQ+O1xufVxuXG5jbGFzcyBUaW1lb3V0QXN5bmNJdGVyYWJsZTxUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRTb3VyY2U+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+O1xuICBwcml2YXRlIF9kdWVUaW1lOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3Ioc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LCBkdWVUaW1lOiBudW1iZXIpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9kdWVUaW1lID0gZHVlVGltZTtcbiAgfVxuXG4gIGFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkge1xuICAgIGNvbnN0IGl0ID0gdGhpcy5fc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpO1xuICAgIHdoaWxlICgxKSB7XG4gICAgICBjb25zdCB7IHR5cGUsIHZhbHVlIH0gPSBhd2FpdCBQcm9taXNlLnJhY2U8VGltZW91dE9wZXJhdGlvbjxUU291cmNlPj4oW1xuICAgICAgICBpdC5uZXh0KCkudGhlbih2YWx1ZSA9PiB7IHJldHVybiB7IHR5cGU6IFZBTFVFX1RZUEUsIHZhbHVlIH07IH0pLFxuICAgICAgICBzbGVlcCh0aGlzLl9kdWVUaW1lKS50aGVuKCgpID0+IHsgcmV0dXJuIHsgdHlwZTogRVJST1JfVFlQRSB9OyB9KVxuICAgICAgXSk7XG5cbiAgICAgIGlmICh0eXBlID09PSBFUlJPUl9UWVBFKSB7XG4gICAgICAgIHRocm93IG5ldyBUaW1lb3V0RXJyb3IoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHZhbHVlLmRvbmUpIHsgYnJlYWs7IH1cbiAgICAgIHlpZWxkIHZhbHVlLnZhbHVlO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdGltZW91dDxUU291cmNlPihcbiAgICBzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgZHVlVGltZTogbnVtYmVyKTogQXN5bmNJdGVyYWJsZVg8VFNvdXJjZT4ge1xuICByZXR1cm4gbmV3IFRpbWVvdXRBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KHNvdXJjZSwgZHVlVGltZSk7XG59Il19
