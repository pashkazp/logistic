Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var asynciterable_1 = require("../asynciterable");
var bindcallback_1 = require("../internal/bindcallback");
var identity_1 = require("../internal/identity");
var tolength_1 = require("../internal/tolength");
var isiterable_1 = require("../internal/isiterable");
var FromArrayIterable = (function (_super) {
    tslib_1.__extends(FromArrayIterable, _super);
    function FromArrayIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromArrayIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var i, length;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        i = 0;
                        length = tolength_1.toLength(this._source.length);
                        _a.label = 1;
                    case 1:
                        if (!(i < length)) return [3 /*break*/, 4];
                        return [4 /*yield*/, tslib_1.__await(this._selector(this._source[i], i++))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 1];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    return FromArrayIterable;
}(asynciterable_1.AsyncIterableX));
var FromAsyncIterable = (function (_super) {
    tslib_1.__extends(FromAsyncIterable, _super);
    function FromAsyncIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromAsyncIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var i, _a, _b, item, e_1_1, e_1, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        i = 0;
                        _d.label = 1;
                    case 1:
                        _d.trys.push([1, 9, 10, 15]);
                        _a = tslib_1.__asyncValues(this._source);
                        _d.label = 2;
                    case 2: return [4 /*yield*/, tslib_1.__await(_a.next())];
                    case 3:
                        if (!(_b = _d.sent(), !_b.done)) return [3 /*break*/, 8];
                        return [4 /*yield*/, tslib_1.__await(_b.value)];
                    case 4:
                        item = _d.sent();
                        return [4 /*yield*/, tslib_1.__await(this._selector(item, i++))];
                    case 5: return [4 /*yield*/, _d.sent()];
                    case 6:
                        _d.sent();
                        _d.label = 7;
                    case 7: return [3 /*break*/, 2];
                    case 8: return [3 /*break*/, 15];
                    case 9:
                        e_1_1 = _d.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 15];
                    case 10:
                        _d.trys.push([10, , 13, 14]);
                        if (!(_b && !_b.done && (_c = _a.return))) return [3 /*break*/, 12];
                        return [4 /*yield*/, tslib_1.__await(_c.call(_a))];
                    case 11:
                        _d.sent();
                        _d.label = 12;
                    case 12: return [3 /*break*/, 14];
                    case 13:
                        if (e_1) throw e_1.error;
                        return [7 /*endfinally*/];
                    case 14: return [7 /*endfinally*/];
                    case 15: return [2 /*return*/];
                }
            });
        });
    };
    return FromAsyncIterable;
}(asynciterable_1.AsyncIterableX));
var FromPromiseIterable = (function (_super) {
    tslib_1.__extends(FromPromiseIterable, _super);
    function FromPromiseIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromPromiseIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var item;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, tslib_1.__await(this._source)];
                    case 1:
                        item = _a.sent();
                        return [4 /*yield*/, tslib_1.__await(this._selector(item, 0))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    return FromPromiseIterable;
}(asynciterable_1.AsyncIterableX));
var AsyncObserver = (function () {
    function AsyncObserver() {
        this.values = [];
        this.hasCompleted = false;
        this.hasError = false;
        this.errorValue = null;
        this.closed = false;
    }
    AsyncObserver.prototype.next = function (value) {
        if (!this.closed) {
            this.values.push(value);
        }
    };
    AsyncObserver.prototype.error = function (err) {
        if (!this.closed) {
            this.closed = true;
            this.hasError = true;
            this.errorValue = err;
        }
    };
    AsyncObserver.prototype.complete = function () {
        if (!this.closed) {
            this.closed = true;
        }
    };
    return AsyncObserver;
}());
var FromObservableAsyncIterable = (function (_super) {
    tslib_1.__extends(FromObservableAsyncIterable, _super);
    function FromObservableAsyncIterable(observable, selector) {
        var _this = _super.call(this) || this;
        _this._observable = observable;
        _this._selector = selector;
        return _this;
    }
    FromObservableAsyncIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var observer, subscription, i;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        observer = new AsyncObserver();
                        subscription = this._observable.subscribe(observer);
                        i = 0;
                        _a.label = 1;
                    case 1:
                        if (!1) return [3 /*break*/, 6];
                        if (!(observer.values.length > 0)) return [3 /*break*/, 4];
                        return [4 /*yield*/, tslib_1.__await(this._selector(observer.values.shift(), i++))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        if (observer.closed) {
                            subscription.unsubscribe();
                            if (observer.hasError) {
                                throw observer.errorValue;
                            }
                            else {
                                return [3 /*break*/, 6];
                            }
                        }
                        _a.label = 5;
                    case 5: return [3 /*break*/, 1];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    return FromObservableAsyncIterable;
}(asynciterable_1.AsyncIterableX));
function isPromise(x) {
    return x != null && Object(x) === x && typeof x['then'] === 'function';
}
function isObservable(x) {
    return x != null && Object(x) === x && typeof x['subscribe'] === 'function';
}
function isArrayLike(x) {
    return x != null && Object(x) === x && typeof x['length'] === 'number';
}
function from(source, selector, thisArg) {
    if (selector === void 0) { selector = identity_1.identityAsync; }
    var fn = bindcallback_1.bindCallback(selector, thisArg, 2);
    if (isiterable_1.isIterable(source) || isiterable_1.isAsyncIterable(source)) {
        return new FromAsyncIterable(source, fn);
    }
    if (isPromise(source)) {
        return new FromPromiseIterable(source, fn);
    }
    if (isObservable(source)) {
        return new FromObservableAsyncIterable(source, fn);
    }
    if (isArrayLike(source)) {
        return new FromArrayIterable(source, fn);
    }
    throw new TypeError('Input type not supported');
}
exports.from = from;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDOUMsRUFBRSxDQUFDLENBQUMsdUJBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSw0QkFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsSUFBSSxpQkFBaUIsQ0FBbUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLG1CQUFtQixDQUFtQixNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsTUFBTSxDQUFDLElBQUksMkJBQTJCLENBQW1CLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixNQUFNLENBQUMsSUFBSSxpQkFBaUIsQ0FBbUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCxNQUFNLElBQUksU0FBUyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDbEQsQ0FBQztBQW5CRCxvQkFtQkMiLCJmaWxlIjoiYXN5bmNpdGVyYWJsZS9mcm9tLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVggfSBmcm9tICcuLi9hc3luY2l0ZXJhYmxlJztcbmltcG9ydCB7IGJpbmRDYWxsYmFjayB9IGZyb20gJy4uL2ludGVybmFsL2JpbmRjYWxsYmFjayc7XG5pbXBvcnQgeyBpZGVudGl0eUFzeW5jIH0gZnJvbSAnLi4vaW50ZXJuYWwvaWRlbnRpdHknO1xuaW1wb3J0IHsgdG9MZW5ndGggfSBmcm9tICcuLi9pbnRlcm5hbC90b2xlbmd0aCc7XG5pbXBvcnQgeyBpc0l0ZXJhYmxlLCBpc0FzeW5jSXRlcmFibGUgfSBmcm9tICcuLi9pbnRlcm5hbC9pc2l0ZXJhYmxlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi9vYnNlcnZlcic7XG5cbmNsYXNzIEZyb21BcnJheUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBBcnJheUxpa2U8VFNvdXJjZT47XG4gIHByaXZhdGUgX3NlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgc291cmNlOiBBcnJheUxpa2U8VFNvdXJjZT4sXG4gICAgICBzZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0Pikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc291cmNlID0gc291cmNlO1xuICAgIHRoaXMuX3NlbGVjdG9yID0gc2VsZWN0b3I7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBsZXQgaSA9IDA7XG4gICAgY29uc3QgbGVuZ3RoID0gdG9MZW5ndGgoKDxBcnJheUxpa2U8VFNvdXJjZT4+dGhpcy5fc291cmNlKS5sZW5ndGgpO1xuICAgIHdoaWxlIChpIDwgbGVuZ3RoKSB7XG4gICAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3Rvcih0aGlzLl9zb3VyY2VbaV0sIGkrKyk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZyb21Bc3luY0l0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBJdGVyYWJsZTxUU291cmNlIHwgUHJvbWlzZUxpa2U8VFNvdXJjZT4+IHwgQXN5bmNJdGVyYWJsZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IEl0ZXJhYmxlPFRTb3VyY2UgfCBQcm9taXNlTGlrZTxUU291cmNlPj4gfCBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgbGV0IGkgPSAwO1xuICAgIGZvciBhd2FpdCAobGV0IGl0ZW0gb2YgPEFzeW5jSXRlcmFibGU8VFNvdXJjZT4+dGhpcy5fc291cmNlKSB7XG4gICAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3RvcihpdGVtLCBpKyspO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBGcm9tUHJvbWlzZUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBQcm9taXNlTGlrZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IFByb21pc2VMaWtlPFRTb3VyY2U+LFxuICAgICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgY29uc3QgaXRlbSA9IGF3YWl0IHRoaXMuX3NvdXJjZTtcbiAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3RvcihpdGVtLCAwKTtcbiAgfVxufVxuXG5jbGFzcyBBc3luY09ic2VydmVyPFRTb3VyY2U+IHtcbiAgcHVibGljIHZhbHVlczogVFNvdXJjZVtdO1xuICBwdWJsaWMgaGFzRXJyb3I6IGJvb2xlYW47XG4gIHB1YmxpYyBoYXNDb21wbGV0ZWQ6IGJvb2xlYW47XG4gIHB1YmxpYyBlcnJvclZhbHVlOiBhbnk7XG4gIHB1YmxpYyBjbG9zZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy52YWx1ZXMgPSBbXTtcbiAgICB0aGlzLmhhc0NvbXBsZXRlZCA9IGZhbHNlO1xuICAgIHRoaXMuaGFzRXJyb3IgPSBmYWxzZTtcbiAgICB0aGlzLmVycm9yVmFsdWUgPSBudWxsO1xuICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7XG4gIH1cblxuICBuZXh0KHZhbHVlOiBUU291cmNlKSB7XG4gICAgaWYgKCF0aGlzLmNsb3NlZCkge1xuICAgICAgdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgZXJyb3IoZXJyOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VkKSB7XG4gICAgICB0aGlzLmNsb3NlZCA9IHRydWU7XG4gICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgIHRoaXMuZXJyb3JWYWx1ZSA9IGVycjtcbiAgICB9XG4gIH1cblxuICBjb21wbGV0ZSgpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VkKSB7XG4gICAgICB0aGlzLmNsb3NlZCA9IHRydWU7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZyb21PYnNlcnZhYmxlQXN5bmNJdGVyYWJsZTxUU291cmNlLCBUUmVzdWx0ID0gVFNvdXJjZT4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0PiB7XG4gIHByaXZhdGUgX29ic2VydmFibGU6IE9ic2VydmFibGU8VFNvdXJjZT47XG4gIHByaXZhdGUgX3NlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgb2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUU291cmNlPixcbiAgICAgIHNlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9vYnNlcnZhYmxlID0gb2JzZXJ2YWJsZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgQXN5bmNPYnNlcnZlcjxUU291cmNlPigpO1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuX29ic2VydmFibGUuc3Vic2NyaWJlKG9ic2VydmVyKTtcblxuICAgIGxldCBpID0gMDtcbiAgICB3aGlsZSAoMSkge1xuICAgICAgaWYgKG9ic2VydmVyLnZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHlpZWxkIGF3YWl0IHRoaXMuX3NlbGVjdG9yKG9ic2VydmVyLnZhbHVlcy5zaGlmdCgpLCBpKyspO1xuICAgICAgfSBlbHNlIGlmIChvYnNlcnZlci5jbG9zZWQpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIGlmIChvYnNlcnZlci5oYXNFcnJvcikge1xuICAgICAgICAgIHRocm93IG9ic2VydmVyLmVycm9yVmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgQXN5bmNJdGVyYWJsZUlucHV0PFRTb3VyY2U+ID1cbiAgSXRlcmFibGU8VFNvdXJjZSB8IFByb21pc2VMaWtlPFRTb3VyY2U+PiB8XG4gIEFzeW5jSXRlcmFibGU8VFNvdXJjZT4gfFxuICBBcnJheUxpa2U8VFNvdXJjZT4gfFxuICBQcm9taXNlTGlrZTxUU291cmNlPiB8XG4gIE9ic2VydmFibGU8VFNvdXJjZT47XG5cbmZ1bmN0aW9uIGlzUHJvbWlzZSh4OiBhbnkpOiB4IGlzIFByb21pc2VMaWtlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsndGhlbiddID09PSAnZnVuY3Rpb24nO1xufVxuXG5mdW5jdGlvbiBpc09ic2VydmFibGUoeDogYW55KTogeCBpcyBPYnNlcnZhYmxlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsnc3Vic2NyaWJlJ10gPT09ICdmdW5jdGlvbic7XG59XG5cbmZ1bmN0aW9uIGlzQXJyYXlMaWtlKHg6IGFueSk6IHggaXMgQXJyYXlMaWtlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsnbGVuZ3RoJ10gPT09ICdudW1iZXInO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbTxUU291cmNlLCBUUmVzdWx0ID0gVFNvdXJjZT4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlSW5wdXQ8VFNvdXJjZT4sXG4gICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4gPSBpZGVudGl0eUFzeW5jLFxuICAgIHRoaXNBcmc/OiBhbnkpOiBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0PiB7XG4gIGNvbnN0IGZuID0gYmluZENhbGxiYWNrKHNlbGVjdG9yLCB0aGlzQXJnLCAyKTtcbiAgaWYgKGlzSXRlcmFibGUoc291cmNlKSB8fCBpc0FzeW5jSXRlcmFibGUoc291cmNlKSkge1xuICAgIHJldHVybiBuZXcgRnJvbUFzeW5jSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdD4oc291cmNlLCBmbik7XG4gIH1cbiAgaWYgKGlzUHJvbWlzZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tUHJvbWlzZUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQ+KHNvdXJjZSwgZm4pO1xuICB9XG4gIGlmIChpc09ic2VydmFibGUoc291cmNlKSkge1xuICAgIHJldHVybiBuZXcgRnJvbU9ic2VydmFibGVBc3luY0l0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQ+KHNvdXJjZSwgZm4pO1xuICB9XG4gIGlmIChpc0FycmF5TGlrZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tQXJyYXlJdGVyYWJsZTxUU291cmNlLCBUUmVzdWx0Pihzb3VyY2UsIGZuKTtcbiAgfVxuXG4gIHRocm93IG5ldyBUeXBlRXJyb3IoJ0lucHV0IHR5cGUgbm90IHN1cHBvcnRlZCcpO1xufVxuIl19
