import * as tslib_1 from "tslib";
import { AsyncIterableX } from '../asynciterable';
import { bindCallback } from '../internal/bindcallback';
import { identityAsync } from '../internal/identity';
import { toLength } from '../internal/tolength';
import { isIterable, isAsyncIterable } from '../internal/isiterable';
var FromArrayIterable = (function (_super) {
    tslib_1.__extends(FromArrayIterable, _super);
    function FromArrayIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromArrayIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var i, length;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        i = 0;
                        length = toLength(this._source.length);
                        _a.label = 1;
                    case 1:
                        if (!(i < length)) return [3 /*break*/, 4];
                        return [4 /*yield*/, tslib_1.__await(this._selector(this._source[i], i++))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 1];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    return FromArrayIterable;
}(AsyncIterableX));
var FromAsyncIterable = (function (_super) {
    tslib_1.__extends(FromAsyncIterable, _super);
    function FromAsyncIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromAsyncIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var i, _a, _b, item, e_1_1, e_1, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        i = 0;
                        _d.label = 1;
                    case 1:
                        _d.trys.push([1, 9, 10, 15]);
                        _a = tslib_1.__asyncValues(this._source);
                        _d.label = 2;
                    case 2: return [4 /*yield*/, tslib_1.__await(_a.next())];
                    case 3:
                        if (!(_b = _d.sent(), !_b.done)) return [3 /*break*/, 8];
                        return [4 /*yield*/, tslib_1.__await(_b.value)];
                    case 4:
                        item = _d.sent();
                        return [4 /*yield*/, tslib_1.__await(this._selector(item, i++))];
                    case 5: return [4 /*yield*/, _d.sent()];
                    case 6:
                        _d.sent();
                        _d.label = 7;
                    case 7: return [3 /*break*/, 2];
                    case 8: return [3 /*break*/, 15];
                    case 9:
                        e_1_1 = _d.sent();
                        e_1 = { error: e_1_1 };
                        return [3 /*break*/, 15];
                    case 10:
                        _d.trys.push([10, , 13, 14]);
                        if (!(_b && !_b.done && (_c = _a.return))) return [3 /*break*/, 12];
                        return [4 /*yield*/, tslib_1.__await(_c.call(_a))];
                    case 11:
                        _d.sent();
                        _d.label = 12;
                    case 12: return [3 /*break*/, 14];
                    case 13:
                        if (e_1) throw e_1.error;
                        return [7 /*endfinally*/];
                    case 14: return [7 /*endfinally*/];
                    case 15: return [2 /*return*/];
                }
            });
        });
    };
    return FromAsyncIterable;
}(AsyncIterableX));
var FromPromiseIterable = (function (_super) {
    tslib_1.__extends(FromPromiseIterable, _super);
    function FromPromiseIterable(source, selector) {
        var _this = _super.call(this) || this;
        _this._source = source;
        _this._selector = selector;
        return _this;
    }
    FromPromiseIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var item;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, tslib_1.__await(this._source)];
                    case 1:
                        item = _a.sent();
                        return [4 /*yield*/, tslib_1.__await(this._selector(item, 0))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    return FromPromiseIterable;
}(AsyncIterableX));
var AsyncObserver = (function () {
    function AsyncObserver() {
        this.values = [];
        this.hasCompleted = false;
        this.hasError = false;
        this.errorValue = null;
        this.closed = false;
    }
    AsyncObserver.prototype.next = function (value) {
        if (!this.closed) {
            this.values.push(value);
        }
    };
    AsyncObserver.prototype.error = function (err) {
        if (!this.closed) {
            this.closed = true;
            this.hasError = true;
            this.errorValue = err;
        }
    };
    AsyncObserver.prototype.complete = function () {
        if (!this.closed) {
            this.closed = true;
        }
    };
    return AsyncObserver;
}());
var FromObservableAsyncIterable = (function (_super) {
    tslib_1.__extends(FromObservableAsyncIterable, _super);
    function FromObservableAsyncIterable(observable, selector) {
        var _this = _super.call(this) || this;
        _this._observable = observable;
        _this._selector = selector;
        return _this;
    }
    FromObservableAsyncIterable.prototype[Symbol.asyncIterator] = function () {
        return tslib_1.__asyncGenerator(this, arguments, function _a() {
            var observer, subscription, i;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        observer = new AsyncObserver();
                        subscription = this._observable.subscribe(observer);
                        i = 0;
                        _a.label = 1;
                    case 1:
                        if (!1) return [3 /*break*/, 6];
                        if (!(observer.values.length > 0)) return [3 /*break*/, 4];
                        return [4 /*yield*/, tslib_1.__await(this._selector(observer.values.shift(), i++))];
                    case 2: return [4 /*yield*/, _a.sent()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        if (observer.closed) {
                            subscription.unsubscribe();
                            if (observer.hasError) {
                                throw observer.errorValue;
                            }
                            else {
                                return [3 /*break*/, 6];
                            }
                        }
                        _a.label = 5;
                    case 5: return [3 /*break*/, 1];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    return FromObservableAsyncIterable;
}(AsyncIterableX));
function isPromise(x) {
    return x != null && Object(x) === x && typeof x['then'] === 'function';
}
function isObservable(x) {
    return x != null && Object(x) === x && typeof x['subscribe'] === 'function';
}
function isArrayLike(x) {
    return x != null && Object(x) === x && typeof x['length'] === 'number';
}
export function from(source, selector, thisArg) {
    if (selector === void 0) { selector = identityAsync; }
    var fn = bindCallback(selector, thisArg, 2);
    if (isIterable(source) || isAsyncIterable(source)) {
        return new FromAsyncIterable(source, fn);
    }
    if (isPromise(source)) {
        return new FromPromiseIterable(source, fn);
    }
    if (isObservable(source)) {
        return new FromObservableAsyncIterable(source, fn);
    }
    if (isArrayLike(source)) {
        return new FromArrayIterable(source, fn);
    }
    throw new TypeError('Input type not supported');
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxRQUFRLENBQUM7QUFDekUsQ0FBQztBQUVELE1BQU0sZUFDRixNQUFtQyxFQUNuQyxRQUF1RixFQUN2RixPQUFhO0lBRGIseUJBQUEsRUFBQSx3QkFBdUY7SUFFekYsSUFBTSxFQUFFLEdBQUcsWUFBWSxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDOUMsRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsTUFBTSxDQUFDLElBQUksaUJBQWlCLENBQW1CLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0QixNQUFNLENBQUMsSUFBSSxtQkFBbUIsQ0FBbUIsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sQ0FBQyxJQUFJLDJCQUEyQixDQUFtQixNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUNELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEIsTUFBTSxDQUFDLElBQUksaUJBQWlCLENBQW1CLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsTUFBTSxJQUFJLFNBQVMsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ2xELENBQUMiLCJmaWxlIjoiYXN5bmNpdGVyYWJsZS9mcm9tLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVggfSBmcm9tICcuLi9hc3luY2l0ZXJhYmxlJztcbmltcG9ydCB7IGJpbmRDYWxsYmFjayB9IGZyb20gJy4uL2ludGVybmFsL2JpbmRjYWxsYmFjayc7XG5pbXBvcnQgeyBpZGVudGl0eUFzeW5jIH0gZnJvbSAnLi4vaW50ZXJuYWwvaWRlbnRpdHknO1xuaW1wb3J0IHsgdG9MZW5ndGggfSBmcm9tICcuLi9pbnRlcm5hbC90b2xlbmd0aCc7XG5pbXBvcnQgeyBpc0l0ZXJhYmxlLCBpc0FzeW5jSXRlcmFibGUgfSBmcm9tICcuLi9pbnRlcm5hbC9pc2l0ZXJhYmxlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi9vYnNlcnZlcic7XG5cbmNsYXNzIEZyb21BcnJheUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBBcnJheUxpa2U8VFNvdXJjZT47XG4gIHByaXZhdGUgX3NlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgc291cmNlOiBBcnJheUxpa2U8VFNvdXJjZT4sXG4gICAgICBzZWxlY3RvcjogKHZhbHVlOiBUU291cmNlLCBpbmRleDogbnVtYmVyKSA9PiBUUmVzdWx0IHwgUHJvbWlzZTxUUmVzdWx0Pikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc291cmNlID0gc291cmNlO1xuICAgIHRoaXMuX3NlbGVjdG9yID0gc2VsZWN0b3I7XG4gIH1cblxuICBhc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBsZXQgaSA9IDA7XG4gICAgY29uc3QgbGVuZ3RoID0gdG9MZW5ndGgoKDxBcnJheUxpa2U8VFNvdXJjZT4+dGhpcy5fc291cmNlKS5sZW5ndGgpO1xuICAgIHdoaWxlIChpIDwgbGVuZ3RoKSB7XG4gICAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3Rvcih0aGlzLl9zb3VyY2VbaV0sIGkrKyk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZyb21Bc3luY0l0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBJdGVyYWJsZTxUU291cmNlIHwgUHJvbWlzZUxpa2U8VFNvdXJjZT4+IHwgQXN5bmNJdGVyYWJsZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IEl0ZXJhYmxlPFRTb3VyY2UgfCBQcm9taXNlTGlrZTxUU291cmNlPj4gfCBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgbGV0IGkgPSAwO1xuICAgIGZvciBhd2FpdCAobGV0IGl0ZW0gb2YgPEFzeW5jSXRlcmFibGU8VFNvdXJjZT4+dGhpcy5fc291cmNlKSB7XG4gICAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3RvcihpdGVtLCBpKyspO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBGcm9tUHJvbWlzZUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQgPSBUU291cmNlPiBleHRlbmRzIEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+IHtcbiAgcHJpdmF0ZSBfc291cmNlOiBQcm9taXNlTGlrZTxUU291cmNlPjtcbiAgcHJpdmF0ZSBfc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgICBzb3VyY2U6IFByb21pc2VMaWtlPFRTb3VyY2U+LFxuICAgICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgY29uc3QgaXRlbSA9IGF3YWl0IHRoaXMuX3NvdXJjZTtcbiAgICB5aWVsZCBhd2FpdCB0aGlzLl9zZWxlY3RvcihpdGVtLCAwKTtcbiAgfVxufVxuXG5jbGFzcyBBc3luY09ic2VydmVyPFRTb3VyY2U+IHtcbiAgcHVibGljIHZhbHVlczogVFNvdXJjZVtdO1xuICBwdWJsaWMgaGFzRXJyb3I6IGJvb2xlYW47XG4gIHB1YmxpYyBoYXNDb21wbGV0ZWQ6IGJvb2xlYW47XG4gIHB1YmxpYyBlcnJvclZhbHVlOiBhbnk7XG4gIHB1YmxpYyBjbG9zZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy52YWx1ZXMgPSBbXTtcbiAgICB0aGlzLmhhc0NvbXBsZXRlZCA9IGZhbHNlO1xuICAgIHRoaXMuaGFzRXJyb3IgPSBmYWxzZTtcbiAgICB0aGlzLmVycm9yVmFsdWUgPSBudWxsO1xuICAgIHRoaXMuY2xvc2VkID0gZmFsc2U7XG4gIH1cblxuICBuZXh0KHZhbHVlOiBUU291cmNlKSB7XG4gICAgaWYgKCF0aGlzLmNsb3NlZCkge1xuICAgICAgdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgZXJyb3IoZXJyOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VkKSB7XG4gICAgICB0aGlzLmNsb3NlZCA9IHRydWU7XG4gICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgIHRoaXMuZXJyb3JWYWx1ZSA9IGVycjtcbiAgICB9XG4gIH1cblxuICBjb21wbGV0ZSgpIHtcbiAgICBpZiAoIXRoaXMuY2xvc2VkKSB7XG4gICAgICB0aGlzLmNsb3NlZCA9IHRydWU7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZyb21PYnNlcnZhYmxlQXN5bmNJdGVyYWJsZTxUU291cmNlLCBUUmVzdWx0ID0gVFNvdXJjZT4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0PiB7XG4gIHByaXZhdGUgX29ic2VydmFibGU6IE9ic2VydmFibGU8VFNvdXJjZT47XG4gIHByaXZhdGUgX3NlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgICAgb2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUU291cmNlPixcbiAgICAgIHNlbGVjdG9yOiAodmFsdWU6IFRTb3VyY2UsIGluZGV4OiBudW1iZXIpID0+IFRSZXN1bHQgfCBQcm9taXNlPFRSZXN1bHQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9vYnNlcnZhYmxlID0gb2JzZXJ2YWJsZTtcbiAgICB0aGlzLl9zZWxlY3RvciA9IHNlbGVjdG9yO1xuICB9XG5cbiAgYXN5bmMgKltTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSB7XG4gICAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgQXN5bmNPYnNlcnZlcjxUU291cmNlPigpO1xuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHRoaXMuX29ic2VydmFibGUuc3Vic2NyaWJlKG9ic2VydmVyKTtcblxuICAgIGxldCBpID0gMDtcbiAgICB3aGlsZSAoMSkge1xuICAgICAgaWYgKG9ic2VydmVyLnZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHlpZWxkIGF3YWl0IHRoaXMuX3NlbGVjdG9yKG9ic2VydmVyLnZhbHVlcy5zaGlmdCgpLCBpKyspO1xuICAgICAgfSBlbHNlIGlmIChvYnNlcnZlci5jbG9zZWQpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIGlmIChvYnNlcnZlci5oYXNFcnJvcikge1xuICAgICAgICAgIHRocm93IG9ic2VydmVyLmVycm9yVmFsdWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgQXN5bmNJdGVyYWJsZUlucHV0PFRTb3VyY2U+ID1cbiAgSXRlcmFibGU8VFNvdXJjZSB8IFByb21pc2VMaWtlPFRTb3VyY2U+PiB8XG4gIEFzeW5jSXRlcmFibGU8VFNvdXJjZT4gfFxuICBBcnJheUxpa2U8VFNvdXJjZT4gfFxuICBQcm9taXNlTGlrZTxUU291cmNlPiB8XG4gIE9ic2VydmFibGU8VFNvdXJjZT47XG5cbmZ1bmN0aW9uIGlzUHJvbWlzZSh4OiBhbnkpOiB4IGlzIFByb21pc2VMaWtlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsndGhlbiddID09PSAnZnVuY3Rpb24nO1xufVxuXG5mdW5jdGlvbiBpc09ic2VydmFibGUoeDogYW55KTogeCBpcyBPYnNlcnZhYmxlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsnc3Vic2NyaWJlJ10gPT09ICdmdW5jdGlvbic7XG59XG5cbmZ1bmN0aW9uIGlzQXJyYXlMaWtlKHg6IGFueSk6IHggaXMgQXJyYXlMaWtlPGFueT4ge1xuICByZXR1cm4geCAhPSBudWxsICYmIE9iamVjdCh4KSA9PT0geCAmJiB0eXBlb2YgeFsnbGVuZ3RoJ10gPT09ICdudW1iZXInO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbTxUU291cmNlLCBUUmVzdWx0ID0gVFNvdXJjZT4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlSW5wdXQ8VFNvdXJjZT4sXG4gICAgc2VsZWN0b3I6ICh2YWx1ZTogVFNvdXJjZSwgaW5kZXg6IG51bWJlcikgPT4gVFJlc3VsdCB8IFByb21pc2U8VFJlc3VsdD4gPSBpZGVudGl0eUFzeW5jLFxuICAgIHRoaXNBcmc/OiBhbnkpOiBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0PiB7XG4gIGNvbnN0IGZuID0gYmluZENhbGxiYWNrKHNlbGVjdG9yLCB0aGlzQXJnLCAyKTtcbiAgaWYgKGlzSXRlcmFibGUoc291cmNlKSB8fCBpc0FzeW5jSXRlcmFibGUoc291cmNlKSkge1xuICAgIHJldHVybiBuZXcgRnJvbUFzeW5jSXRlcmFibGU8VFNvdXJjZSwgVFJlc3VsdD4oc291cmNlLCBmbik7XG4gIH1cbiAgaWYgKGlzUHJvbWlzZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tUHJvbWlzZUl0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQ+KHNvdXJjZSwgZm4pO1xuICB9XG4gIGlmIChpc09ic2VydmFibGUoc291cmNlKSkge1xuICAgIHJldHVybiBuZXcgRnJvbU9ic2VydmFibGVBc3luY0l0ZXJhYmxlPFRTb3VyY2UsIFRSZXN1bHQ+KHNvdXJjZSwgZm4pO1xuICB9XG4gIGlmIChpc0FycmF5TGlrZShzb3VyY2UpKSB7XG4gICAgcmV0dXJuIG5ldyBGcm9tQXJyYXlJdGVyYWJsZTxUU291cmNlLCBUUmVzdWx0Pihzb3VyY2UsIGZuKTtcbiAgfVxuXG4gIHRocm93IG5ldyBUeXBlRXJyb3IoJ0lucHV0IHR5cGUgbm90IHN1cHBvcnRlZCcpO1xufVxuIl19
