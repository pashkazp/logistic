goog.module('targets.es5.cls.asynciterable.memoize'); exports = {}; var module = {id: 'targets/es5/cls/asynciterable/memoize.js'};/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

var asynciterable_1 = goog.require('targets.es5.cls.asynciterable');
var tsickle_forward_declare_1 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable");
var _refcountlist_1 = goog.require('targets.es5.cls.iterable._refcountlist');
var tsickle_forward_declare_2 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.iterable._refcountlist");
var create_1 = goog.require('targets.es5.cls.asynciterable.create');
var tsickle_forward_declare_3 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable.create");
/**
 * @template T
 */
var MemoizeAsyncBuffer = (function (_super) {
    __extends(MemoizeAsyncBuffer, _super);
    /**
     * @param {!AsyncIterator<T>} source
     * @param {!tsickle_forward_declare_2.IRefCountList<T>} buffer
     */
    function MemoizeAsyncBuffer(source, buffer) {
        var _this = _super.call(this) || this;
        _this._stopped = false;
        _this._source = source;
        _this._buffer = buffer;
        return _this;
    }
    /**
     * @return {!AsyncIterableIterator<T>}
     */
    MemoizeAsyncBuffer.prototype[Symbol.asyncIterator] = function () {
        return __asyncGenerator(this, arguments, function _a() {
            var i, hasValue, current, next, e_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        i = 0;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, , 13, 14]);
                        _a.label = 2;
                    case 2:
                        if (!1) return [3 /*break*/, 12];
                        hasValue = false, current = ({});
                        if (!(i >= this._buffer.count)) return [3 /*break*/, 7];
                        if (!!this._stopped) return [3 /*break*/, 6];
                        _a.label = 3;
                    case 3:
                        _a.trys.push([3, 5, , 6]);
                        return [4 /*yield*/, __await(this._source.next())];
                    case 4:
                        next = _a.sent();
                        hasValue = !next.done;
                        if (hasValue) {
                            current = next.value;
                        }
                        return [3 /*break*/, 6];
                    case 5:
                        e_1 = _a.sent();
                        this._error = e_1;
                        this._stopped = true;
                        return [3 /*break*/, 6];
                    case 6:
                        if (this._stopped) {
                            throw this._error;
                        }
                        if (hasValue) {
                            this._buffer.push(current);
                        }
                        return [3 /*break*/, 8];
                    case 7:
                        hasValue = true;
                        _a.label = 8;
                    case 8:
                        if (!hasValue) return [3 /*break*/, 10];
                        return [4 /*yield*/, this._buffer.get(i)];
                    case 9:
                        _a.sent();
                        return [3 /*break*/, 11];
                    case 10: return [3 /*break*/, 12];
                    case 11:
                        i++;
                        return [3 /*break*/, 2];
                    case 12: return [3 /*break*/, 14];
                    case 13:
                        this._buffer.done();
                        return [7 /*endfinally*/];
                    case 14: return [2 /*return*/];
                }
            });
        });
    };
    return MemoizeAsyncBuffer;
}(asynciterable_1.AsyncIterableX));
function MemoizeAsyncBuffer_tsickle_Closure_declarations() {
    /** @type {!AsyncIterator<T>} */
    MemoizeAsyncBuffer.prototype._source;
    /** @type {!tsickle_forward_declare_2.IRefCountList<T>} */
    MemoizeAsyncBuffer.prototype._buffer;
    /** @type {?} */
    MemoizeAsyncBuffer.prototype._error;
    /** @type {boolean} */
    MemoizeAsyncBuffer.prototype._stopped;
}
/**
 * @template TSource, TResult
 * @param {!AsyncIterable<TSource>} source
 * @param {number=} readerCount
 * @param {function(!AsyncIterable<TSource>): !AsyncIterable<TResult>=} selector
 * @return {!tsickle_forward_declare_1.AsyncIterableX<(TSource|TResult)>}
 */
function memoize(source, readerCount, selector) {
    if (readerCount === void 0) { readerCount = -1; }
    if (readerCount === -1 && !selector) {
        return new MemoizeAsyncBuffer(source[Symbol.asyncIterator](), new _refcountlist_1.MaxRefCountList());
    }
    if (readerCount !== -1 && !selector) {
        return new MemoizeAsyncBuffer(source[Symbol.asyncIterator](), new _refcountlist_1.RefCountList(readerCount));
    }
    return create_1.create(function () { /** @type {function(!AsyncIterable<TSource>): !AsyncIterable<TResult>} */ return ((selector))(memoize(source, readerCount))[Symbol.asyncIterator](); });
}
exports.memoize = memoize;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hc3luY2l0ZXJhYmxlL21lbW9pemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILGtEQUx1QjtBQU12QixJQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsMkNBQTJDLENBQUMsQ0FOaEQ7QUFPbEQsMkRBTnFEO0FBT3JELElBQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvREFBb0QsQ0FBQyxDQVBsQjtBQVF6RixtQ0FQZTtBQVFmLElBQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQzFHOztHQUVHO0FBVEg7SUFBbUMsc0NBQWtCO0lBZXJEOzs7T0FHRztJQVpELDRCQUFZLE1BQXdCLEVBQUMsTUFBeUI7UUFBOUQsWUFjRSxpQkFiTyxTQWdCUjtRQW5CTSxjQUFTLEdBQVcsS0FBTSxDQUFBO1FBaUIvQixLQWJJLENBQUMsT0FBTyxHQUFFLE1BQU8sQ0FBQztRQWN0QixLQWJJLENBQUMsT0FBTyxHQUFFLE1BQU8sQ0FBQzs7SUFjeEIsQ0FBQztJQUNIOztPQUVHO0lBZE0sNkJBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUE3Qjs7Ozs7O3dCQUNLLENBQUUsR0FBRSxDQUFFLENBQUM7Ozs7Ozs2QkFFRCxDQUFDO3dCQUNILFFBQVMsR0FBRSxLQUFNLEVBQUMsT0FBUSxHQUFBLENBQU0sRUFBQSxDQUFFLENBQUM7NkJBQ2xDLENBQUEsQ0FBQyxJQUFHLElBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFBLEVBQXZCLHdCQUF1Qjs2QkFDckIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFkLHdCQUFjOzs7O3dCQUVKLDZCQUFNLElBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUE7O3dCQUFqQyxJQUFLLEdBQUUsU0FBMEI7d0JBZ0JwQyxRQWZRLEdBQUUsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFDO3dCQWdCdEIsRUFBRSxDQUFDLENBZkMsUUFBUSxDQUFDLENBQUEsQ0FBRTs0QkFBQSxPQUFRLEdBQUUsSUFBSyxDQUFDLEtBQUssQ0FBQzt3QkFBQSxDQUFFOzs7O3dCQWlCdkMsSUFmSSxDQUFDLE1BQU0sR0FBRSxHQUFFLENBQUM7d0JBZ0JoQixJQWZJLENBQUMsUUFBUSxHQUFFLElBQUssQ0FBQzs7O3dCQW1CekIsRUFBRSxDQUFDLENBZkMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUU7NEJBZ0JsQixNQWZLLElBQUssQ0FBQyxNQUFNLENBQUM7d0JBZ0JwQixDQWZDO3dCQWlCRCxFQUFFLENBQUMsQ0FmQyxRQUFRLENBQUMsQ0FBQSxDQUFFOzRCQUFBLElBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUFBLENBQUU7Ozt3QkFpQjdDLFFBZlEsR0FBRSxJQUFLLENBQUM7Ozs2QkFHZCxRQUFRLEVBQVIseUJBQVE7d0JBZ0JWLHFCQWZLLElBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFBOzt3QkFlekIsU0FmeUIsQ0FBQzs7NkJBaUIxQix5QkFmTTs7d0JBa0JSLENBZkMsRUFBRSxDQUFDOzs7O3dCQWtCTixJQWZJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDOzs7Ozs7S0FFdkI7SUFDSCx5QkFBQTtBQUFBLENBbERBLEFBa0RBLENBbERtQyw4QkFBZSxHQWtEbEQ7QUFpQkE7SUFDQSxnQ0FBZ0M7SUFDaEMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztJQUNyQywwREFBMEQ7SUFDMUQsa0JBQWtCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztJQUNyQyxnQkFBZ0I7SUFDaEIsa0JBQWtCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQztJQUNwQyxzQkFBc0I7SUFDdEIsa0JBQWtCLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztBQUN0QyxDQUFDO0FBU0Q7Ozs7OztHQU1HO0FBakNILGlCQW1DSSxNQWxDOEIsRUFtQzlCLFdBbEN3QixFQW1DeEIsUUFsQ29FO0lBaUNwRSw0QkFBQSxFQUFBLGVBbEN1QixDQUFDO0lBb0MxQixFQUFFLENBQUMsQ0FsQ0MsV0FBVyxLQUFJLENBQUUsQ0FBQyxJQUFHLENBQUUsUUFBUSxDQUFDLENBQUEsQ0FBRTtRQW1DcEMsTUFsQ00sQ0FBQSxJQUFJLGtCQUFtQixDQUFVLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBQyxJQUFJLCtCQUFnQixFQUFXLENBQUMsQ0FBQztJQW1DekcsQ0FsQ0M7SUFvQ0QsRUFBRSxDQUFDLENBbENDLFdBQVcsS0FBSSxDQUFFLENBQUMsSUFBRyxDQUFFLFFBQVEsQ0FBQyxDQUFBLENBQUU7UUFtQ3BDLE1BbENNLENBQUEsSUFBSSxrQkFBbUIsQ0FBVSxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUMsSUFBSSw0QkFBYSxDQUFVLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFtQ2pILENBbENDO0lBb0NELE1BbENNLENBQUEsZUFBTyxDQUFvQixjQUFFLHlFQUFBLENBQUEsT0FBQSxDQUFBLENBQUcsUUFBQSxDQUFBLENBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFDLFdBQVksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQW5FLENBQW1FLENBQUMsQ0FBQztBQW1DMUcsQ0FsQ0M7QUFiRCwwQkFhQyIsImZpbGUiOiJtZW1vaXplLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGVvdmVydmlldyBhZGRlZCBieSB0c2lja2xlXG4gKiBAc3VwcHJlc3Mge2NoZWNrVHlwZXN9IGNoZWNrZWQgYnkgdHNjXG4gKi9cblxuaW1wb3J0IHsgQXN5bmNJdGVyYWJsZVggfSBmcm9tICcuLi9hc3luY2l0ZXJhYmxlJztcbmNvbnN0IHRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzEgPSBnb29nLmZvcndhcmREZWNsYXJlKFwiX1VzZXJzLnB0YXlsb3IuZGV2Lml4anMuc3JjLmFzeW5jaXRlcmFibGVcIik7XG5pbXBvcnQgeyBJUmVmQ291bnRMaXN0LCBNYXhSZWZDb3VudExpc3QsIFJlZkNvdW50TGlzdCB9IGZyb20gJy4uL2l0ZXJhYmxlL19yZWZjb3VudGxpc3QnO1xuY29uc3QgdHNpY2tsZV9mb3J3YXJkX2RlY2xhcmVfMiA9IGdvb2cuZm9yd2FyZERlY2xhcmUoXCJfVXNlcnMucHRheWxvci5kZXYuaXhqcy5zcmMuaXRlcmFibGUuX3JlZmNvdW50bGlzdFwiKTtcbmltcG9ydCB7IGNyZWF0ZSB9IGZyb20gJy4vY3JlYXRlJztcbmNvbnN0IHRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzMgPSBnb29nLmZvcndhcmREZWNsYXJlKFwiX1VzZXJzLnB0YXlsb3IuZGV2Lml4anMuc3JjLmFzeW5jaXRlcmFibGUuY3JlYXRlXCIpO1xuLyoqXG4gKiBAdGVtcGxhdGUgVFxuICovXG5jbGFzcyBNZW1vaXplQXN5bmNCdWZmZXI8VD4gZXh0ZW5kcyBBc3luY0l0ZXJhYmxlWDxUPiB7XG5wcml2YXRlIF9zb3VyY2U6IEFzeW5jSXRlcmF0b3I8VD47XG5wcml2YXRlIF9idWZmZXI6IElSZWZDb3VudExpc3Q8VD47XG5wcml2YXRlIF9lcnJvcjogYW55O1xucHJpdmF0ZSBfc3RvcHBlZDogYm9vbGVhbiA9IGZhbHNlO1xuLyoqXG4gKiBAcGFyYW0geyFBc3luY0l0ZXJhdG9yPFQ+fSBzb3VyY2VcbiAqIEBwYXJhbSB7IXRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzIuSVJlZkNvdW50TGlzdDxUPn0gYnVmZmVyXG4gKi9cbmNvbnN0cnVjdG9yKHNvdXJjZTogQXN5bmNJdGVyYXRvcjxUPiwgYnVmZmVyOiBJUmVmQ291bnRMaXN0PFQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zb3VyY2UgPSBzb3VyY2U7XG4gICAgdGhpcy5fYnVmZmVyID0gYnVmZmVyO1xuICB9XG4vKipcbiAqIEByZXR1cm4geyFBc3luY0l0ZXJhYmxlSXRlcmF0b3I8VD59XG4gKi9cbmFzeW5jICpbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkge1xuICAgIGxldCAvKiogQHR5cGUge251bWJlcn0gKi8gaSA9IDA7XG4gICAgdHJ5IHtcbiAgICAgIHdoaWxlICgxKSB7XG4gICAgICAgIGxldCAvKiogQHR5cGUge2Jvb2xlYW59ICovIGhhc1ZhbHVlID0gZmFsc2UsIC8qKiBAdHlwZSB7VH0gKi8gY3VycmVudCA9IC8qKiBAdHlwZSB7VH0gKi8oKCA8VD57fSkpO1xuICAgICAgICBpZiAoaSA+PSB0aGlzLl9idWZmZXIuY291bnQpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX3N0b3BwZWQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGxldCAvKiogQHR5cGUgeyFJdGVyYXRvclJlc3VsdDxUPn0gKi8gbmV4dCA9IGF3YWl0IHRoaXMuX3NvdXJjZS5uZXh0KCk7XG4gICAgICAgICAgICAgIGhhc1ZhbHVlID0gIW5leHQuZG9uZTtcbiAgICAgICAgICAgICAgaWYgKGhhc1ZhbHVlKSB7IGN1cnJlbnQgPSBuZXh0LnZhbHVlOyB9XG4gICAgICAgICAgICB9IGNhdGNoICggLyoqIEB0eXBlIHs/fSAqL2UpIHtcbiAgICAgICAgICAgICAgdGhpcy5fZXJyb3IgPSBlO1xuICAgICAgICAgICAgICB0aGlzLl9zdG9wcGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAodGhpcy5fc3RvcHBlZCkge1xuICAgICAgICAgICAgdGhyb3cgdGhpcy5fZXJyb3I7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGhhc1ZhbHVlKSB7IHRoaXMuX2J1ZmZlci5wdXNoKGN1cnJlbnQpOyB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGFzVmFsdWUgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhhc1ZhbHVlKSB7XG4gICAgICAgICAgeWllbGQgdGhpcy5fYnVmZmVyLmdldChpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5fYnVmZmVyLmRvbmUoKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gTWVtb2l6ZUFzeW5jQnVmZmVyX3RzaWNrbGVfQ2xvc3VyZV9kZWNsYXJhdGlvbnMoKSB7XG4vKiogQHR5cGUgeyFBc3luY0l0ZXJhdG9yPFQ+fSAqL1xuTWVtb2l6ZUFzeW5jQnVmZmVyLnByb3RvdHlwZS5fc291cmNlO1xuLyoqIEB0eXBlIHshdHNpY2tsZV9mb3J3YXJkX2RlY2xhcmVfMi5JUmVmQ291bnRMaXN0PFQ+fSAqL1xuTWVtb2l6ZUFzeW5jQnVmZmVyLnByb3RvdHlwZS5fYnVmZmVyO1xuLyoqIEB0eXBlIHs/fSAqL1xuTWVtb2l6ZUFzeW5jQnVmZmVyLnByb3RvdHlwZS5fZXJyb3I7XG4vKiogQHR5cGUge2Jvb2xlYW59ICovXG5NZW1vaXplQXN5bmNCdWZmZXIucHJvdG90eXBlLl9zdG9wcGVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVtb2l6ZTxUU291cmNlPihcbiAgICBzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgcmVhZGVyQ291bnQ/OiBudW1iZXIpOiBBc3luY0l0ZXJhYmxlWDxUU291cmNlPjtcbmV4cG9ydCBmdW5jdGlvbiBtZW1vaXplPFRTb3VyY2UsIFRSZXN1bHQ+KFxuICAgIHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPixcbiAgICByZWFkZXJDb3VudD86IG51bWJlcixcbiAgICBzZWxlY3Rvcj86ICh2YWx1ZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPikgPT4gQXN5bmNJdGVyYWJsZTxUUmVzdWx0Pik6IEFzeW5jSXRlcmFibGVYPFRSZXN1bHQ+O1xuLyoqXG4gKiBAdGVtcGxhdGUgVFNvdXJjZSwgVFJlc3VsdFxuICogQHBhcmFtIHshQXN5bmNJdGVyYWJsZTxUU291cmNlPn0gc291cmNlXG4gKiBAcGFyYW0ge251bWJlcj19IHJlYWRlckNvdW50XG4gKiBAcGFyYW0ge2Z1bmN0aW9uKCFBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KTogIUFzeW5jSXRlcmFibGU8VFJlc3VsdD49fSBzZWxlY3RvclxuICogQHJldHVybiB7IXRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzEuQXN5bmNJdGVyYWJsZVg8KFRTb3VyY2V8VFJlc3VsdCk+fVxuICovXG5leHBvcnQgZnVuY3Rpb24gbWVtb2l6ZTxUU291cmNlLCBUUmVzdWx0ID0gVFNvdXJjZT4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgIHJlYWRlckNvdW50OiBudW1iZXIgPSAtMSxcbiAgICBzZWxlY3Rvcj86ICh2YWx1ZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPikgPT4gQXN5bmNJdGVyYWJsZTxUUmVzdWx0Pik6IEFzeW5jSXRlcmFibGVYPFRTb3VyY2UgfCBUUmVzdWx0PiB7XG4gIGlmIChyZWFkZXJDb3VudCA9PT0gLTEgJiYgIXNlbGVjdG9yKSB7XG4gICAgcmV0dXJuIG5ldyBNZW1vaXplQXN5bmNCdWZmZXI8VFNvdXJjZT4oc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpLCBuZXcgTWF4UmVmQ291bnRMaXN0PFRTb3VyY2U+KCkpO1xuICB9XG5cbiAgaWYgKHJlYWRlckNvdW50ICE9PSAtMSAmJiAhc2VsZWN0b3IpIHtcbiAgICByZXR1cm4gbmV3IE1lbW9pemVBc3luY0J1ZmZlcjxUU291cmNlPihzb3VyY2VbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCksIG5ldyBSZWZDb3VudExpc3Q8VFNvdXJjZT4ocmVhZGVyQ291bnQpKTtcbiAgfVxuXG4gIHJldHVybiBjcmVhdGU8VFNvdXJjZSB8IFRSZXN1bHQ+KCgpID0+IC8qKiBAdHlwZSB7ZnVuY3Rpb24oIUFzeW5jSXRlcmFibGU8VFNvdXJjZT4pOiAhQXN5bmNJdGVyYWJsZTxUUmVzdWx0Pn0gKi8oKCBzZWxlY3RvcikpKG1lbW9pemUoc291cmNlLCByZWFkZXJDb3VudCkpW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpKTtcbn1cbiJdfQ==