goog.module('targets.esnext.cls.asynciterable.publish'); exports = {}; var module = {id: 'targets/esnext/cls/asynciterable/publish.js'};/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

var asynciterable_1 = goog.require('targets.esnext.cls.asynciterable');
const tsickle_forward_declare_1 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable");
var _refcountlist_1 = goog.require('targets.esnext.cls.iterable._refcountlist');
const tsickle_forward_declare_2 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.iterable._refcountlist");
var create_1 = goog.require('targets.esnext.cls.asynciterable.create');
const tsickle_forward_declare_3 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable.create");
/**
 * @template T
 */
class PublishedAsyncBuffer extends asynciterable_1.AsyncIterableX {
    /**
     * @param {!AsyncIterator<T>} source
     */
    constructor(source) {
        super();
        this._stopped = false;
        this._source = source;
        this._buffer = new _refcountlist_1.RefCountList(0);
    }
    /**
     * @param {number} i
     * @return {!AsyncIterable<T>}
     */
    async *_getIterable(i) {
        try {
            while (1) {
                let /** @type {boolean} */ hasValue = false, /** @type {T} */ current = ({});
                if (i >= this._buffer.count) {
                    if (!this._stopped) {
                        try {
                            let /** @type {!IteratorResult<T>} */ next = await this._source.next();
                            hasValue = !next.done;
                            if (hasValue) {
                                current = next.value;
                            }
                        }
                        catch (e) {
                            this._error = e;
                            this._stopped = true;
                        }
                    }
                    if (this._stopped) {
                        if (this._error) {
                            throw this._error;
                        }
                        else {
                            break;
                        }
                    }
                    if (hasValue) {
                        this._buffer.push(current);
                    }
                }
                else {
                    hasValue = true;
                }
                if (hasValue) {
                    yield this._buffer.get(i);
                }
                else {
                    break;
                }
                i++;
            }
        }
        finally {
            this._buffer.done();
        }
    }
    /**
     * @return {!AsyncIterator<T>}
     */
    [Symbol.asyncIterator]() {
        this._buffer.readerCount++;
        return this._getIterable(this._buffer.count)[Symbol.asyncIterator]();
    }
}
function PublishedAsyncBuffer_tsickle_Closure_declarations() {
    /** @type {!tsickle_forward_declare_2.RefCountList<T>} */
    PublishedAsyncBuffer.prototype._buffer;
    /** @type {!AsyncIterator<T>} */
    PublishedAsyncBuffer.prototype._source;
    /** @type {?} */
    PublishedAsyncBuffer.prototype._error;
    /** @type {boolean} */
    PublishedAsyncBuffer.prototype._stopped;
}
/**
 * @template TSource, TResult
 * @param {!AsyncIterable<TSource>} source
 * @param {function(!AsyncIterable<TSource>): !AsyncIterable<TResult>=} selector
 * @return {!tsickle_forward_declare_1.AsyncIterableX<(TSource|TResult)>}
 */
function publish(source, selector) {
    return selector ?
        create_1.create(async () => selector(publish(source))[Symbol.asyncIterator]()) :
        new PublishedAsyncBuffer(source[Symbol.asyncIterator]());
}
exports.publish = publish;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hc3luY2l0ZXJhYmxlL3B1Ymxpc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILG9EQUx1QjtBQU12QixNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsMkNBQTJDLENBQUMsQ0FOaEQ7QUFPbEQsNkRBTnFCO0FBT3JCLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvREFBb0QsQ0FBQyxDQVBsRDtBQVF6RCxxQ0FQZTtBQVFmLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQzFHOztHQUVHO0FBVEgsMEJBQTZCLFNBQVEsOEJBQWtCO0lBZXZEOztPQUVHO0lBWEQsWUFBWSxNQUF3QjtRQWFsQyxLQVpLLEVBQUUsQ0FBQztRQUhILGFBQVMsR0FBVyxLQUFNLENBQUE7UUFnQi9CLElBWkksQ0FBQyxPQUFPLEdBQUUsTUFBTyxDQUFDO1FBYXRCLElBWkksQ0FBQyxPQUFPLEdBQUUsSUFBSSw0QkFBYSxDQUFJLENBQUMsQ0FBQyxDQUFDO0lBYXhDLENBQUM7SUFDSDs7O09BR0c7SUFkTSxLQUFNLEVBQUUsWUFBWSxDQUFDLENBQVM7UUFpQm5DLElBaEJHLENBQUU7WUFpQkgsT0FoQk8sQ0FBQyxFQUFDLENBQUU7Z0JBaUJULElBQUksc0JBaEJELENBQUEsUUFBUyxHQUFFLEtBQU0sRUFBQSxnQkFBQyxDQUFBLE9BQVEsR0FBQSxDQUFNLEVBQUEsQ0FBRSxDQUFDO2dCQWlCdEMsRUFBRSxDQUFDLENBaEJDLENBQUMsSUFBRyxJQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBLENBQUU7b0JBaUI1QixFQUFFLENBQUMsQ0FoQkMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBRTt3QkFpQm5CLElBaEJHLENBQUU7NEJBaUJILElBQUksaUNBaEJELENBQUEsSUFBSyxHQUFFLE1BQU0sSUFBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQzs0QkFpQnJDLFFBaEJRLEdBQUUsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFDOzRCQWlCdEIsRUFBRSxDQUFDLENBaEJDLFFBQVEsQ0FBQyxDQUFBLENBQUU7Z0NBQUEsT0FBUSxHQUFFLElBQUssQ0FBQyxLQUFLLENBQUM7NEJBQUEsQ0FBRTt3QkFpQnpDLENBaEJDO3dCQUFBLEtBQUEsQ0FBQSxDQUFRLENBQUMsQ0FBQyxDQUFBLENBQUU7NEJBaUJYLElBaEJJLENBQUMsTUFBTSxHQUFFLENBQUUsQ0FBQzs0QkFpQmhCLElBaEJJLENBQUMsUUFBUSxHQUFFLElBQUssQ0FBQzt3QkFpQnZCLENBaEJDO29CQWlCSCxDQWhCQztvQkFrQkQsRUFBRSxDQUFDLENBaEJDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQSxDQUFFO3dCQWlCbEIsRUFBRSxDQUFDLENBaEJDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQSxDQUFFOzRCQWlCaEIsTUFoQkssSUFBSyxDQUFDLE1BQU0sQ0FBQzt3QkFpQnBCLENBaEJDO3dCQUFBLElBQUssQ0FBQSxDQUFFOzRCQWlCTixLQUFLLENBaEJDO3dCQWlCUixDQWhCQztvQkFpQkgsQ0FoQkM7b0JBa0JELEVBQUUsQ0FBQyxDQWhCQyxRQUFRLENBQUMsQ0FBQSxDQUFFO3dCQUFBLElBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUFBLENBQUU7Z0JBaUIvQyxDQWhCQztnQkFBQSxJQUFLLENBQUEsQ0FBRTtvQkFpQk4sUUFoQlEsR0FBRSxJQUFLLENBQUM7Z0JBaUJsQixDQWhCQztnQkFrQkQsRUFBRSxDQUFDLENBaEJDLFFBQVEsQ0FBQyxDQUFBLENBQUU7b0JBaUJiLE1BaEJLLElBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQWlCNUIsQ0FoQkM7Z0JBQUEsSUFBSyxDQUFBLENBQUU7b0JBaUJOLEtBQUssQ0FoQkM7Z0JBaUJSLENBaEJDO2dCQWtCRCxDQWhCQyxFQUFFLENBQUM7WUFpQk4sQ0FoQkM7UUFpQkgsQ0FoQkM7Z0JBQVEsQ0FBRTtZQWlCVCxJQWhCSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQWlCdEIsQ0FoQkM7SUFpQkgsQ0FBQztJQUNIOztPQUVHO0lBakJELENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQztRQW1CcEIsSUFsQkksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFtQjNCLE1BbEJNLENBQUEsSUFBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO0lBbUJ2RSxDQWxCQztDQUNIO0FBb0JBO0lBQ0EseURBQXlEO0lBQ3pELG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7SUFDdkMsZ0NBQWdDO0lBQ2hDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7SUFDdkMsZ0JBQWdCO0lBQ2hCLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7SUFDdEMsc0JBQXNCO0lBQ3RCLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7QUFDeEMsQ0FBQztBQU9EOzs7OztHQUtHO0FBbkNILGlCQXFDSSxNQXBDOEIsRUFxQzlCLFFBcENvRTtJQXFDdEUsTUFwQ00sQ0FBQSxRQUFTO1FBcUNiLGVBcENNLENBQUMsS0FBSyxPQUFNLFFBQVMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztRQXFDckUsSUFwQ0csb0JBQXFCLENBQVUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7QUFxQ3RFLENBcENDO0FBTkQsMEJBTUMiLCJmaWxlIjoicHVibGlzaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlb3ZlcnZpZXcgYWRkZWQgYnkgdHNpY2tsZVxuICogQHN1cHByZXNzIHtjaGVja1R5cGVzfSBjaGVja2VkIGJ5IHRzY1xuICovXG5cbmltcG9ydCB7IEFzeW5jSXRlcmFibGVYIH0gZnJvbSAnLi4vYXN5bmNpdGVyYWJsZSc7XG5jb25zdCB0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8xID0gZ29vZy5mb3J3YXJkRGVjbGFyZShcIl9Vc2Vycy5wdGF5bG9yLmRldi5peGpzLnNyYy5hc3luY2l0ZXJhYmxlXCIpO1xuaW1wb3J0IHsgUmVmQ291bnRMaXN0IH0gZnJvbSAnLi4vaXRlcmFibGUvX3JlZmNvdW50bGlzdCc7XG5jb25zdCB0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8yID0gZ29vZy5mb3J3YXJkRGVjbGFyZShcIl9Vc2Vycy5wdGF5bG9yLmRldi5peGpzLnNyYy5pdGVyYWJsZS5fcmVmY291bnRsaXN0XCIpO1xuaW1wb3J0IHsgY3JlYXRlIH0gZnJvbSAnLi9jcmVhdGUnO1xuY29uc3QgdHNpY2tsZV9mb3J3YXJkX2RlY2xhcmVfMyA9IGdvb2cuZm9yd2FyZERlY2xhcmUoXCJfVXNlcnMucHRheWxvci5kZXYuaXhqcy5zcmMuYXN5bmNpdGVyYWJsZS5jcmVhdGVcIik7XG4vKipcbiAqIEB0ZW1wbGF0ZSBUXG4gKi9cbmNsYXNzIFB1Ymxpc2hlZEFzeW5jQnVmZmVyPFQ+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZVg8VD4ge1xucHJpdmF0ZSBfYnVmZmVyOiBSZWZDb3VudExpc3Q8VD47XG5wcml2YXRlIF9zb3VyY2U6IEFzeW5jSXRlcmF0b3I8VD47XG5wcml2YXRlIF9lcnJvcjogYW55O1xucHJpdmF0ZSBfc3RvcHBlZDogYm9vbGVhbiA9IGZhbHNlO1xuLyoqXG4gKiBAcGFyYW0geyFBc3luY0l0ZXJhdG9yPFQ+fSBzb3VyY2VcbiAqL1xuY29uc3RydWN0b3Ioc291cmNlOiBBc3luY0l0ZXJhdG9yPFQ+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zb3VyY2UgPSBzb3VyY2U7XG4gICAgdGhpcy5fYnVmZmVyID0gbmV3IFJlZkNvdW50TGlzdDxUPigwKTtcbiAgfVxuLyoqXG4gKiBAcGFyYW0ge251bWJlcn0gaVxuICogQHJldHVybiB7IUFzeW5jSXRlcmFibGU8VD59XG4gKi9cblxucHJpdmF0ZSBhc3luYyAqX2dldEl0ZXJhYmxlKGk6IG51bWJlcik6IEFzeW5jSXRlcmFibGU8VD4ge1xuICAgIHRyeSB7XG4gICAgICB3aGlsZSAoMSkge1xuICAgICAgICBsZXQgLyoqIEB0eXBlIHtib29sZWFufSAqLyBoYXNWYWx1ZSA9IGZhbHNlLCAvKiogQHR5cGUge1R9ICovIGN1cnJlbnQgPSAvKiogQHR5cGUge1R9ICovKCggPFQ+e30pKTtcbiAgICAgICAgaWYgKGkgPj0gdGhpcy5fYnVmZmVyLmNvdW50KSB7XG4gICAgICAgICAgaWYgKCF0aGlzLl9zdG9wcGVkKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBsZXQgLyoqIEB0eXBlIHshSXRlcmF0b3JSZXN1bHQ8VD59ICovIG5leHQgPSBhd2FpdCB0aGlzLl9zb3VyY2UubmV4dCgpO1xuICAgICAgICAgICAgICBoYXNWYWx1ZSA9ICFuZXh0LmRvbmU7XG4gICAgICAgICAgICAgIGlmIChoYXNWYWx1ZSkgeyBjdXJyZW50ID0gbmV4dC52YWx1ZTsgfVxuICAgICAgICAgICAgfSBjYXRjaCAoIC8qKiBAdHlwZSB7P30gKi9lKSB7XG4gICAgICAgICAgICAgIHRoaXMuX2Vycm9yID0gZTtcbiAgICAgICAgICAgICAgdGhpcy5fc3RvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRoaXMuX3N0b3BwZWQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9lcnJvcikge1xuICAgICAgICAgICAgICB0aHJvdyB0aGlzLl9lcnJvcjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChoYXNWYWx1ZSkgeyB0aGlzLl9idWZmZXIucHVzaChjdXJyZW50KTsgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGhhc1ZhbHVlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNWYWx1ZSkge1xuICAgICAgICAgIHlpZWxkIHRoaXMuX2J1ZmZlci5nZXQoaSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2J1ZmZlci5kb25lKCk7XG4gICAgfVxuICB9XG4vKipcbiAqIEByZXR1cm4geyFBc3luY0l0ZXJhdG9yPFQ+fVxuICovXG5bU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk6IEFzeW5jSXRlcmF0b3I8VD4ge1xuICAgIHRoaXMuX2J1ZmZlci5yZWFkZXJDb3VudCsrO1xuICAgIHJldHVybiB0aGlzLl9nZXRJdGVyYWJsZSh0aGlzLl9idWZmZXIuY291bnQpW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIFB1Ymxpc2hlZEFzeW5jQnVmZmVyX3RzaWNrbGVfQ2xvc3VyZV9kZWNsYXJhdGlvbnMoKSB7XG4vKiogQHR5cGUgeyF0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8yLlJlZkNvdW50TGlzdDxUPn0gKi9cblB1Ymxpc2hlZEFzeW5jQnVmZmVyLnByb3RvdHlwZS5fYnVmZmVyO1xuLyoqIEB0eXBlIHshQXN5bmNJdGVyYXRvcjxUPn0gKi9cblB1Ymxpc2hlZEFzeW5jQnVmZmVyLnByb3RvdHlwZS5fc291cmNlO1xuLyoqIEB0eXBlIHs/fSAqL1xuUHVibGlzaGVkQXN5bmNCdWZmZXIucHJvdG90eXBlLl9lcnJvcjtcbi8qKiBAdHlwZSB7Ym9vbGVhbn0gKi9cblB1Ymxpc2hlZEFzeW5jQnVmZmVyLnByb3RvdHlwZS5fc3RvcHBlZDtcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcHVibGlzaDxUU291cmNlPihzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pOiBBc3luY0l0ZXJhYmxlWDxUU291cmNlPjtcbmV4cG9ydCBmdW5jdGlvbiBwdWJsaXNoPFRTb3VyY2UsIFRSZXN1bHQ+KFxuICBzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gIHNlbGVjdG9yPzogKHZhbHVlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KSA9PiBBc3luY0l0ZXJhYmxlPFRSZXN1bHQ+KTogQXN5bmNJdGVyYWJsZVg8VFJlc3VsdD47XG4vKipcbiAqIEB0ZW1wbGF0ZSBUU291cmNlLCBUUmVzdWx0XG4gKiBAcGFyYW0geyFBc3luY0l0ZXJhYmxlPFRTb3VyY2U+fSBzb3VyY2VcbiAqIEBwYXJhbSB7ZnVuY3Rpb24oIUFzeW5jSXRlcmFibGU8VFNvdXJjZT4pOiAhQXN5bmNJdGVyYWJsZTxUUmVzdWx0Pj19IHNlbGVjdG9yXG4gKiBAcmV0dXJuIHshdHNpY2tsZV9mb3J3YXJkX2RlY2xhcmVfMS5Bc3luY0l0ZXJhYmxlWDwoVFNvdXJjZXxUUmVzdWx0KT59XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwdWJsaXNoPFRTb3VyY2UsIFRSZXN1bHQ+KFxuICAgIHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPixcbiAgICBzZWxlY3Rvcj86ICh2YWx1ZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPikgPT4gQXN5bmNJdGVyYWJsZTxUUmVzdWx0Pik6IEFzeW5jSXRlcmFibGVYPFRTb3VyY2UgfCBUUmVzdWx0PiB7XG4gIHJldHVybiBzZWxlY3RvciA/XG4gICAgY3JlYXRlKGFzeW5jICgpID0+IHNlbGVjdG9yKHB1Ymxpc2goc291cmNlKSlbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCkpIDpcbiAgICBuZXcgUHVibGlzaGVkQXN5bmNCdWZmZXI8VFNvdXJjZT4oc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpKTtcbn1cbiJdfQ==