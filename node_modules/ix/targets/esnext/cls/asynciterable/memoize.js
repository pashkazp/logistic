goog.module('targets.esnext.cls.asynciterable.memoize'); exports = {}; var module = {id: 'targets/esnext/cls/asynciterable/memoize.js'};/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */

var asynciterable_1 = goog.require('targets.esnext.cls.asynciterable');
const tsickle_forward_declare_1 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable");
var _refcountlist_1 = goog.require('targets.esnext.cls.iterable._refcountlist');
const tsickle_forward_declare_2 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.iterable._refcountlist");
var create_1 = goog.require('targets.esnext.cls.asynciterable.create');
const tsickle_forward_declare_3 = goog.forwardDeclare("_Users.ptaylor.dev.ixjs.src.asynciterable.create");
/**
 * @template T
 */
class MemoizeAsyncBuffer extends asynciterable_1.AsyncIterableX {
    /**
     * @param {!AsyncIterator<T>} source
     * @param {!tsickle_forward_declare_2.IRefCountList<T>} buffer
     */
    constructor(source, buffer) {
        super();
        this._stopped = false;
        this._source = source;
        this._buffer = buffer;
    }
    /**
     * @return {!AsyncIterableIterator<T>}
     */
    async *[Symbol.asyncIterator]() {
        let /** @type {number} */ i = 0;
        try {
            while (1) {
                let /** @type {boolean} */ hasValue = false, /** @type {T} */ current = ({});
                if (i >= this._buffer.count) {
                    if (!this._stopped) {
                        try {
                            let /** @type {!IteratorResult<T>} */ next = await this._source.next();
                            hasValue = !next.done;
                            if (hasValue) {
                                current = next.value;
                            }
                        }
                        catch (e) {
                            this._error = e;
                            this._stopped = true;
                        }
                    }
                    if (this._stopped) {
                        throw this._error;
                    }
                    if (hasValue) {
                        this._buffer.push(current);
                    }
                }
                else {
                    hasValue = true;
                }
                if (hasValue) {
                    yield this._buffer.get(i);
                }
                else {
                    break;
                }
                i++;
            }
        }
        finally {
            this._buffer.done();
        }
    }
}
function MemoizeAsyncBuffer_tsickle_Closure_declarations() {
    /** @type {!AsyncIterator<T>} */
    MemoizeAsyncBuffer.prototype._source;
    /** @type {!tsickle_forward_declare_2.IRefCountList<T>} */
    MemoizeAsyncBuffer.prototype._buffer;
    /** @type {?} */
    MemoizeAsyncBuffer.prototype._error;
    /** @type {boolean} */
    MemoizeAsyncBuffer.prototype._stopped;
}
/**
 * @template TSource, TResult
 * @param {!AsyncIterable<TSource>} source
 * @param {number=} readerCount
 * @param {function(!AsyncIterable<TSource>): !AsyncIterable<TResult>=} selector
 * @return {!tsickle_forward_declare_1.AsyncIterableX<(TSource|TResult)>}
 */
function memoize(source, readerCount = -1, selector) {
    if (readerCount === -1 && !selector) {
        return new MemoizeAsyncBuffer(source[Symbol.asyncIterator](), new _refcountlist_1.MaxRefCountList());
    }
    if (readerCount !== -1 && !selector) {
        return new MemoizeAsyncBuffer(source[Symbol.asyncIterator](), new _refcountlist_1.RefCountList(readerCount));
    }
    return create_1.create(() => ((selector))(memoize(source, readerCount))[Symbol.asyncIterator]());
}
exports.memoize = memoize;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hc3luY2l0ZXJhYmxlL21lbW9pemUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILG9EQUx1QjtBQU12QixNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsMkNBQTJDLENBQUMsQ0FOaEQ7QUFPbEQsNkRBTnFEO0FBT3JELE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxvREFBb0QsQ0FBQyxDQVBsQjtBQVF6RixxQ0FQZTtBQVFmLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0FBQzFHOztHQUVHO0FBVEgsd0JBQTJCLFNBQVEsOEJBQWtCO0lBZXJEOzs7T0FHRztJQVpELFlBQVksTUFBd0IsRUFBQyxNQUF5QjtRQWM1RCxLQWJLLEVBQUUsQ0FBQztRQUhILGFBQVMsR0FBVyxLQUFNLENBQUE7UUFpQi9CLElBYkksQ0FBQyxPQUFPLEdBQUUsTUFBTyxDQUFDO1FBY3RCLElBYkksQ0FBQyxPQUFPLEdBQUUsTUFBTyxDQUFDO0lBY3hCLENBQUM7SUFDSDs7T0FFRztJQWRELEtBQUssRUFBRSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFnQjNCLElBQUkscUJBZkQsQ0FBQSxDQUFFLEdBQUUsQ0FBRSxDQUFDO1FBZ0JWLElBZkcsQ0FBRTtZQWdCSCxPQWZPLENBQUMsRUFBQyxDQUFFO2dCQWdCVCxJQUFJLHNCQWZELENBQUEsUUFBUyxHQUFFLEtBQU0sRUFBQSxnQkFBQyxDQUFBLE9BQVEsR0FBQSxDQUFNLEVBQUEsQ0FBRSxDQUFDO2dCQWdCdEMsRUFBRSxDQUFDLENBZkMsQ0FBQyxJQUFHLElBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUEsQ0FBRTtvQkFnQjVCLEVBQUUsQ0FBQyxDQWZDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBLENBQUU7d0JBZ0JuQixJQWZHLENBQUU7NEJB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Y2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlb3ZlcnZpZXcgYWRkZWQgYnkgdHNpY2tsZVxuICogQHN1cHByZXNzIHtjaGVja1R5cGVzfSBjaGVja2VkIGJ5IHRzY1xuICovXG5cbmltcG9ydCB7IEFzeW5jSXRlcmFibGVYIH0gZnJvbSAnLi4vYXN5bmNpdGVyYWJsZSc7XG5jb25zdCB0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8xID0gZ29vZy5mb3J3YXJkRGVjbGFyZShcIl9Vc2Vycy5wdGF5bG9yLmRldi5peGpzLnNyYy5hc3luY2l0ZXJhYmxlXCIpO1xuaW1wb3J0IHsgSVJlZkNvdW50TGlzdCwgTWF4UmVmQ291bnRMaXN0LCBSZWZDb3VudExpc3QgfSBmcm9tICcuLi9pdGVyYWJsZS9fcmVmY291bnRsaXN0JztcbmNvbnN0IHRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzIgPSBnb29nLmZvcndhcmREZWNsYXJlKFwiX1VzZXJzLnB0YXlsb3IuZGV2Lml4anMuc3JjLml0ZXJhYmxlLl9yZWZjb3VudGxpc3RcIik7XG5pbXBvcnQgeyBjcmVhdGUgfSBmcm9tICcuL2NyZWF0ZSc7XG5jb25zdCB0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8zID0gZ29vZy5mb3J3YXJkRGVjbGFyZShcIl9Vc2Vycy5wdGF5bG9yLmRldi5peGpzLnNyYy5hc3luY2l0ZXJhYmxlLmNyZWF0ZVwiKTtcbi8qKlxuICogQHRlbXBsYXRlIFRcbiAqL1xuY2xhc3MgTWVtb2l6ZUFzeW5jQnVmZmVyPFQ+IGV4dGVuZHMgQXN5bmNJdGVyYWJsZVg8VD4ge1xucHJpdmF0ZSBfc291cmNlOiBBc3luY0l0ZXJhdG9yPFQ+O1xucHJpdmF0ZSBfYnVmZmVyOiBJUmVmQ291bnRMaXN0PFQ+O1xucHJpdmF0ZSBfZXJyb3I6IGFueTtcbnByaXZhdGUgX3N0b3BwZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbi8qKlxuICogQHBhcmFtIHshQXN5bmNJdGVyYXRvcjxUPn0gc291cmNlXG4gKiBAcGFyYW0geyF0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8yLklSZWZDb3VudExpc3Q8VD59IGJ1ZmZlclxuICovXG5jb25zdHJ1Y3Rvcihzb3VyY2U6IEFzeW5jSXRlcmF0b3I8VD4sIGJ1ZmZlcjogSVJlZkNvdW50TGlzdDxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc291cmNlID0gc291cmNlO1xuICAgIHRoaXMuX2J1ZmZlciA9IGJ1ZmZlcjtcbiAgfVxuLyoqXG4gKiBAcmV0dXJuIHshQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFQ+fVxuICovXG5hc3luYyAqW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpIHtcbiAgICBsZXQgLyoqIEB0eXBlIHtudW1iZXJ9ICovIGkgPSAwO1xuICAgIHRyeSB7XG4gICAgICB3aGlsZSAoMSkge1xuICAgICAgICBsZXQgLyoqIEB0eXBlIHtib29sZWFufSAqLyBoYXNWYWx1ZSA9IGZhbHNlLCAvKiogQHR5cGUge1R9ICovIGN1cnJlbnQgPSAvKiogQHR5cGUge1R9ICovKCggPFQ+e30pKTtcbiAgICAgICAgaWYgKGkgPj0gdGhpcy5fYnVmZmVyLmNvdW50KSB7XG4gICAgICAgICAgaWYgKCF0aGlzLl9zdG9wcGVkKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBsZXQgLyoqIEB0eXBlIHshSXRlcmF0b3JSZXN1bHQ8VD59ICovIG5leHQgPSBhd2FpdCB0aGlzLl9zb3VyY2UubmV4dCgpO1xuICAgICAgICAgICAgICBoYXNWYWx1ZSA9ICFuZXh0LmRvbmU7XG4gICAgICAgICAgICAgIGlmIChoYXNWYWx1ZSkgeyBjdXJyZW50ID0gbmV4dC52YWx1ZTsgfVxuICAgICAgICAgICAgfSBjYXRjaCAoIC8qKiBAdHlwZSB7P30gKi9lKSB7XG4gICAgICAgICAgICAgIHRoaXMuX2Vycm9yID0gZTtcbiAgICAgICAgICAgICAgdGhpcy5fc3RvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRoaXMuX3N0b3BwZWQpIHtcbiAgICAgICAgICAgIHRocm93IHRoaXMuX2Vycm9yO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChoYXNWYWx1ZSkgeyB0aGlzLl9idWZmZXIucHVzaChjdXJyZW50KTsgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGhhc1ZhbHVlID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoYXNWYWx1ZSkge1xuICAgICAgICAgIHlpZWxkIHRoaXMuX2J1ZmZlci5nZXQoaSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2J1ZmZlci5kb25lKCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIE1lbW9pemVBc3luY0J1ZmZlcl90c2lja2xlX0Nsb3N1cmVfZGVjbGFyYXRpb25zKCkge1xuLyoqIEB0eXBlIHshQXN5bmNJdGVyYXRvcjxUPn0gKi9cbk1lbW9pemVBc3luY0J1ZmZlci5wcm90b3R5cGUuX3NvdXJjZTtcbi8qKiBAdHlwZSB7IXRzaWNrbGVfZm9yd2FyZF9kZWNsYXJlXzIuSVJlZkNvdW50TGlzdDxUPn0gKi9cbk1lbW9pemVBc3luY0J1ZmZlci5wcm90b3R5cGUuX2J1ZmZlcjtcbi8qKiBAdHlwZSB7P30gKi9cbk1lbW9pemVBc3luY0J1ZmZlci5wcm90b3R5cGUuX2Vycm9yO1xuLyoqIEB0eXBlIHtib29sZWFufSAqL1xuTWVtb2l6ZUFzeW5jQnVmZmVyLnByb3RvdHlwZS5fc3RvcHBlZDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lbW9pemU8VFNvdXJjZT4oXG4gICAgc291cmNlOiBBc3luY0l0ZXJhYmxlPFRTb3VyY2U+LFxuICAgIHJlYWRlckNvdW50PzogbnVtYmVyKTogQXN5bmNJdGVyYWJsZVg8VFNvdXJjZT47XG5leHBvcnQgZnVuY3Rpb24gbWVtb2l6ZTxUU291cmNlLCBUUmVzdWx0PihcbiAgICBzb3VyY2U6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4sXG4gICAgcmVhZGVyQ291bnQ/OiBudW1iZXIsXG4gICAgc2VsZWN0b3I/OiAodmFsdWU6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pID0+IEFzeW5jSXRlcmFibGU8VFJlc3VsdD4pOiBBc3luY0l0ZXJhYmxlWDxUUmVzdWx0Pjtcbi8qKlxuICogQHRlbXBsYXRlIFRTb3VyY2UsIFRSZXN1bHRcbiAqIEBwYXJhbSB7IUFzeW5jSXRlcmFibGU8VFNvdXJjZT59IHNvdXJjZVxuICogQHBhcmFtIHtudW1iZXI9fSByZWFkZXJDb3VudFxuICogQHBhcmFtIHtmdW5jdGlvbighQXN5bmNJdGVyYWJsZTxUU291cmNlPik6ICFBc3luY0l0ZXJhYmxlPFRSZXN1bHQ+PX0gc2VsZWN0b3JcbiAqIEByZXR1cm4geyF0c2lja2xlX2ZvcndhcmRfZGVjbGFyZV8xLkFzeW5jSXRlcmFibGVYPChUU291cmNlfFRSZXN1bHQpPn1cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1lbW9pemU8VFNvdXJjZSwgVFJlc3VsdCA9IFRTb3VyY2U+KFxuICAgIHNvdXJjZTogQXN5bmNJdGVyYWJsZTxUU291cmNlPixcbiAgICByZWFkZXJDb3VudDogbnVtYmVyID0gLTEsXG4gICAgc2VsZWN0b3I/OiAodmFsdWU6IEFzeW5jSXRlcmFibGU8VFNvdXJjZT4pID0+IEFzeW5jSXRlcmFibGU8VFJlc3VsdD4pOiBBc3luY0l0ZXJhYmxlWDxUU291cmNlIHwgVFJlc3VsdD4ge1xuICBpZiAocmVhZGVyQ291bnQgPT09IC0xICYmICFzZWxlY3Rvcikge1xuICAgIHJldHVybiBuZXcgTWVtb2l6ZUFzeW5jQnVmZmVyPFRTb3VyY2U+KHNvdXJjZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSwgbmV3IE1heFJlZkNvdW50TGlzdDxUU291cmNlPigpKTtcbiAgfVxuXG4gIGlmIChyZWFkZXJDb3VudCAhPT0gLTEgJiYgIXNlbGVjdG9yKSB7XG4gICAgcmV0dXJuIG5ldyBNZW1vaXplQXN5bmNCdWZmZXI8VFNvdXJjZT4oc291cmNlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpLCBuZXcgUmVmQ291bnRMaXN0PFRTb3VyY2U+KHJlYWRlckNvdW50KSk7XG4gIH1cblxuICByZXR1cm4gY3JlYXRlPFRTb3VyY2UgfCBUUmVzdWx0PigoKSA9PiAvKiogQHR5cGUge2Z1bmN0aW9uKCFBc3luY0l0ZXJhYmxlPFRTb3VyY2U+KTogIUFzeW5jSXRlcmFibGU8VFJlc3VsdD59ICovKCggc2VsZWN0b3IpKShtZW1vaXplKHNvdXJjZSwgcmVhZGVyQ291bnQpKVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKSk7XG59XG4iXX0=